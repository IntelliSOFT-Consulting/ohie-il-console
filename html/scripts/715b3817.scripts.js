"use strict";function toggleSubMenu(a){var b=$(a).parent("li"),c=$(a).next("ul");b.hasClass("open")?(c.slideUp(350),b.removeClass("open")):($(".nav > li > ul").slideUp(350),$(".nav > li").removeClass("open"),c.slideDown(350),b.addClass("open"))}function isBase64String(a){var b=new RegExp("^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=|[A-Za-z0-9+/]{4})([=]{1,2})?$");return b.test(a)}function decodeBase64(a){var b=CryptoJS.enc.Base64.parse(a),c=b.toString(CryptoJS.enc.Utf8);return c}function getHashAndSalt(a){var b=CryptoJS.lib.WordArray.random(16).toString(),c=CryptoJS.algo.SHA512.create();c.update(b),c.update(a);var d=c.finalize();return{hash:d.toString(CryptoJS.enc.Hex),salt:b,algorithm:"sha512"}}function viewPage(a){var b=window.location.href+a;window.location=b}function isValidMSISDN(a){if(a){var b=/^([1-9]\d{1})([0-9]{3,13})$/;return a.match(b)?!0:!1}}function returnContentType(a){var b="";return a["Content-Type"]?b=a["Content-Type"]:a["content-type"]&&(b=a["content-type"]),b}function beautifyIndent(a,b){try{if(a.indexOf("text/xml")>=0||a.indexOf("application/xml")>=0)return{lang:"xml",content:vkbeautify.xml(b,2)};if(a.indexOf("text/json")>=0||a.indexOf("application/json")>=0)return{lang:"json",content:vkbeautify.json(b,2)};if(a.indexOf("text/html")>=0||a.indexOf("application/html")>=0)return{lang:"html",content:vkbeautify.xml(b,2)};if(/.*application\/\w+\+xml.*/.test(a))return{lang:"xml",content:vkbeautify.xml(b,2)}}catch(c){return{lang:"",content:b}}return{lang:"",content:b}}function isCoreVersionCompatible(a,b){var c=a.split("."),d=b.split(".");return c[0]===d[0]&&c[1]<=d[1]?!0:!1}function buildBlob(a,b){var c;try{c=new Blob([a],{type:b})}catch(d){var e=function(){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder};if("TypeError"===d.name&&window.BlobBuilder){var f=new e;f.append(a),c=f.getBlob(b)}else c="InvalidStateError"===d.name?new Blob([a],{type:b}):{error:"Browser not supported for Blob creation"}}return c}function getTimeForTimezone(a){var b=moment(new Date).tz(a);return moment(b).format("YYYY-MM-DD HH:mm:ss Z")}function getTimezoneOffset(a){var b=moment(new Date).tz(a);return moment(b).format("Z")}var app=angular.module("openhimConsoleApp",["ngCookies","ngResource","ngSanitize","ngRoute","ui.bootstrap","angular_taglist_directive","hljs","angularFileUpload","datetimepicker","colorpicker.module","FBAngular"]);!function(){function a(){var a=angular.injector(["ng"]),b=a.get("$http");return b.get("config/default.json").then(function(a){app.constant("config",a.data)},function(){app.constant("config","No Config Loaded")})}function b(){angular.element(document).ready(function(){angular.bootstrap(document,["openhimConsoleApp"])})}a().then(b)}(),app.config(["$compileProvider",function(a){a.aHrefSanitizationWhitelist(/^\s*(https?|ftp|file|blob):/)}]),app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/dashboard.html",controller:"DashboardCtrl"}).when("/channels",{templateUrl:"views/channels.html",controller:"ChannelsCtrl"}).when("/channels/:channelId",{templateUrl:"views/channelMonitoring.html",controller:"ChannelMonitoringCtrl"}).when("/clients",{templateUrl:"views/clients.html",controller:"ClientsCtrl"}).when("/monitoring",{templateUrl:"views/monitoring.html",controller:"MonitoringCtrl"}).when("/users",{templateUrl:"views/users.html",controller:"UsersCtrl"}).when("/config",{templateUrl:"views/config.html",controller:"ConfigCtrl"}).when("/transactions",{templateUrl:"views/transactions.html",controller:"TransactionsCtrl"}).when("/transactions/:transactionId",{templateUrl:"views/transactionDetails.html",controller:"TransactionDetailsCtrl"}).when("/tasks",{templateUrl:"views/tasks.html",controller:"TasksCtrl"}).when("/tasks/:taskId",{templateUrl:"views/taskDetails.html",controller:"TaskDetailsCtrl"}).when("/groups",{templateUrl:"views/contactGroups.html",controller:"ContactGroupsCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/profile",{templateUrl:"views/profile.html",controller:"ProfileCtrl"}).when("/mediators",{templateUrl:"views/mediators.html",controller:"MediatorsCtrl"}).when("/mediators/:urn",{templateUrl:"views/mediatorDetails.html",controller:"MediatorDetailsCtrl"}).when("/logout",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/visualizer",{templateUrl:"views/visualizer.html",controller:"VisualizerCtrl"}).when("/forgot-password",{templateUrl:"views/forgotPassword.html",controller:"ForgotPasswordCtrl"}).when("/set-password/:token",{templateUrl:"views/setPassword.html",controller:"SetPasswordCtrl"}).when("/certificates",{templateUrl:"views/certificates.html",controller:"CertificatesCtrl"}).when("/export-import",{templateUrl:"views/exportImport.html",controller:"ExportImportCtrl"}).when("/audits",{templateUrl:"views/audits.html",controller:"AuditsCtrl"}).when("/audits/:auditId",{templateUrl:"views/auditDetails.html",controller:"AuditDetailsCtrl"}).when("/logs",{templateUrl:"views/logs.html",controller:"LogsCtrl"}).when("/about",{templateUrl:"views/about.html",controller:"AboutCtrl"}).otherwise({redirectTo:"/"})}]),app.run(["$rootScope","$http","$location","$window","$anchorScroll","Alerting","config",function(a,b,c,d,e,f,g){a.uiSettings={},a.uiSettings.showTooltips=!0,a.appTitle=g.title,a.appFooterTitle=g.footerTitle,a.appFooterPoweredBy=g.footerPoweredBy,a.footerConsoleVersion=null,a.footerCoreVersion=null,a.loginBanner=g.loginBanner,f.AlertValidationMsgs(),a.goToTop=function(){e()},a.$on("$routeChangeStart",function(){var b,f="";b=c.path(),Object.keys(c.search()).length>0&&(angular.forEach(c.search(),function(a,b){f+="&"+b+"="+a}),f=f.substring(1),f="?"+f),"/"!==b&&-1===b.indexOf("/login")&&"/logout"!==b&&-1===b.indexOf("/forgot-password")&&-1===b.indexOf("/set-password")&&(a.referringURL=b+f),e(),a.navMenuVisible=!1;var g=localStorage.getItem("consoleSession");if(g=JSON.parse(g)){a.navMenuVisible=!0;var h=new Date;if(h=h.toISOString(),h>=g.expires)localStorage.removeItem("consoleSession"),d.location="#/login";else{h=new Date;var i=new Date(h.getTime()+72e5),j=g.sessionID,k=g.sessionUser,l=g.sessionUserGroups,m=g.sessionUserSettings,n={sessionID:j,sessionUser:k,sessionUserGroups:l,sessionUserSettings:m,expires:i};localStorage.setItem("consoleSession",JSON.stringify(n)),a.sessionUser=k,a.passwordHash=a.passwordHash||!1,m&&m.general&&(a.uiSettings.showTooltips=m.general.showTooltips),a.userGroupAdmin=l.indexOf("admin")>=0?!0:!1}}else 1!==c.path().indexOf("set-password")&&1!==c.path().indexOf("forgot-password")&&1!==c.path().indexOf("login")&&(d.location="#/login")})}]),angular.module("openhimConsoleApp").controller("DashboardCtrl",["$scope","$modal","$location","$interval","Api","Alerting","Metrics",function(a,b,c,d,e,f,g){function h(b){if(0===b.length)f.AlertAddMsg("load","warning",o),f.AlertAddMsg("responseTime","warning",o);else{var c=function(a){return a.toFixed(2)};a.transactionLoadData=g.buildLineChartData(a.selectedDateType,b,"total"),a.transactionResponseTimeData=g.buildLineChartData(a.selectedDateType,b,"avgResp",c)}}function i(a){f.AlertAddMsg("load","danger","Transaction Load Error: "+a.status+" "+a.data),f.AlertAddMsg("responseTime","danger","Transaction Load Error: "+a.status+" "+a.data)}function j(){e.MetricsTimeseries.query({type:a.selectedDateType.type,startDate:moment(a.selectedDateType.from).format(),endDate:moment(a.selectedDateType.until).format()},h,i)}function k(b){a.activeChannels=b.length;var c;e.Channels.query(function(d){c={},angular.forEach(d,function(a){c[a._id]=a.name});for(var e,f=[],g=[],h=[],i=[],j=0;j<b.length;j++)e={},e.link="channels/"+b[j]._id.channelID,e.channel=c[b[j]._id.channelID],e.processing=b[j].processing,-1===g.indexOf("processing")&&(g.push("processing"),h.push("Processing"),i.push("#777777")),e.failed=b[j].failed,-1===g.indexOf("failed")&&(g.push("failed"),h.push("Failed"),i.push("#d9534f")),e.completed=b[j].completed,-1===g.indexOf("completed")&&(g.push("completed"),h.push("Completed"),i.push("#f0ad4e")),e.completedWErrors=b[j].completedWErrors,-1===g.indexOf("completedWErrors")&&(g.push("completedWErrors"),h.push("Completed With Errors"),i.push("#5bc0de")),e.successful=b[j].successful,-1===g.indexOf("successful")&&(g.push("successful"),h.push("Successful"),i.push("#5cb85c")),f.push(e);a.channelsData={data:f,xkey:"channel",ykeys:g,labels:h,colors:i,stacked:!0}},function(a){f.AlertAddMsg("status","danger","Channel Load Error: "+a.status+" "+a.data)})}function l(a){0===a.length?f.AlertAddMsg("status","warning",o):k(a)}function m(a){f.AlertAddMsg("status","danger","Transaction Load Error: "+a.status+" "+a.data)}function n(){e.MetricsChannels.query({startDate:moment(a.selectedDateType.from).format(),endDate:moment(a.selectedDateType.until).format()},l,m)}var o="There has been no transactions received for the queried timeframe";a.selectedDateType={period:"1d"};var p=d(function(){a.updateMetrics()},5e3);a.updateMetrics=function(){f.AlertReset("load"),f.AlertReset("responseTime"),f.AlertReset("status"),g.refreshDatesForSelectedPeriod(a.selectedDateType),j(),n()},a.updateMetrics(),a.$on("$destroy",function(){angular.isDefined(p)&&(d.cancel(p),p=void 0)})}]),angular.module("openhimConsoleApp").controller("ChannelsCtrl",["$scope","$modal","Api","Alerting",function(a,b,c,d){var e=function(b){a.channels=b,0===b.length&&d.AlertAddMsg("bottom","warning","There are currently no channels created")},f=function(a){d.AlertAddServerMsg(a.status)};c.Channels.query(e,f),a.$on("channelsChanged",function(){c.Channels.query(e,f)}),a.addChannel=function(){d.AlertReset(),b.open({templateUrl:"views/channelsmodal.html",controller:"ChannelsModalCtrl",resolve:{channel:function(){},channelDuplicate:function(){},tab:function(){}}})},a.editChannel=function(a,c){d.AlertReset(),b.open({templateUrl:"views/channelsmodal.html",controller:"ChannelsModalCtrl",resolve:{channel:function(){return a},channelDuplicate:function(){},tab:function(){return c}}})},a.duplicateChannel=function(a){d.AlertReset(),b.open({templateUrl:"views/channelsmodal.html",controller:"ChannelsModalCtrl",resolve:{channel:function(){},channelDuplicate:function(){return a._id},tab:function(){}}})};var g=function(){a.channels=c.Channels.query(),d.AlertAddMsg("top","success","The channel has been deleted successfully")},h=function(a){d.AlertAddMsg("top","danger","An error has occurred while deleting the channel: #"+a.status+" - "+a.data)};a.confirmDelete=function(a){d.AlertReset();var c={title:"Delete Channel",button:"Delete",message:'Are you sure you wish to delete the channel "'+a.name+'"?'},e=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});e.result.then(function(){a.$remove(g,h)},function(){})};var i=function(){a.channels=c.Channels.query(),d.AlertAddMsg("top","success","The channel has been successfully restored")},j=function(a){d.AlertAddMsg("top","danger","An error has occurred while restoring the channel: #"+a.status+" - "+a.data)};a.confirmRestore=function(a){d.AlertReset();var c={title:"Restore Channel",button:"Restore",message:'Are you sure you want to restore the deleted channel "'+a.name+'"?'},e=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});e.result.then(function(){a.status="enabled",a.$update(i,j)},function(){})},a.updateChannelPriority=function(b,c){var e,f=b.priority;if(f)if("up"===c){if(1===f)return;e=f-1}else e=f+1;else e=a.getLowestPriority()+1;b.priority=e,b.$update(function(){a.$broadcast("channelsChanged")},function(a){d.AlertAddMsg("top","danger","An error has occurred while updating the channel: #"+a.status+" - "+a.data)})},a.getLowestPriority=function(){for(var b=0,c=0;c<a.channels.length;c++)a.channels[c].priority&&a.channels[c].priority>b&&(b=a.channels[c].priority);return b}}]);var app=angular.module("openhimConsoleApp");app.controller("ChannelsModalCtrl",["$scope","$modalInstance","$timeout","Api","Notify","Alerting","channel","channelDuplicate","tab",function(a,b,c,d,e,f,g,h,i){switch(a.ngError={},a.urlPattern={},a.urlPattern.regex=!0,a.matching={},a.matching.contentMatching="No matching",a.matching.showRequestMatching=!1,a.autoRetry={},a.autoRetry.enableMaxAttempts=!1,d.Users.query(function(b){a.users=b},function(){}),g?(a.update=!0,a.channel=d.Channels.get({channelId:g._id},function(b){a.autoRetry.enableMaxAttempts=b.autoRetryMaxAttempts>0})):(a.update=!1,h?(a.channelDuplicate=!0,a.channel=d.Channels.get({channelId:h},function(b){delete b._id,delete b.name,a.channel=b,a.autoRetry.enableMaxAttempts=b.autoRetryMaxAttempts>0})):a.channel=new d.Channels),a.selectedTab={},i){case"Basic Info":a.selectedTab.basicInfo=!0;break;case"Request Matching":a.selectedTab.requestMatching=!0;break;case"Routes":a.selectedTab.routes=!0;break;case"Data Control":a.selectedTab.dataControl=!0;break;case"Access Control":a.selectedTab.accessControl=!0;break;case"Alerts":a.selectedTab.alerts=!0;break;default:a.selectedTab.basicInfo=!0}var j=function(){e.notify("channelsChanged"),b.close()},k=function(){f.AlertAddMsg("top","success","The channel has been saved successfully"),j()},l=function(a){f.AlertAddMsg("top","danger","An error has occurred while saving the channels' details: #"+a.status+" - "+a.data),j()};a.saveOrUpdate=function(b){switch(a.urlPattern.regex===!0&&(b.urlPattern="^"+b.urlPattern+"$"),b.type){case"tcp":b.pollingSchedule=null;break;case"tls":b.pollingSchedule=null;break;case"polling":b.tcpHost=null,b.tcpPort=null;break;default:b.pollingSchedule=null,b.tcpHost=null,b.tcpPort=null}switch(a.matching.contentMatching){case"RegEx matching":b.matchContentXpath=null,b.matchContentJson=null,b.matchContentValue=null;break;case"XML matching":b.matchContentRegex=null,b.matchContentJson=null;break;case"JSON matching":b.matchContentRegex=null,b.matchContentXpath=null;break;default:b.matchContentRegex=null,b.matchContentXpath=null,b.matchContentJson=null,b.matchContentValue=null}b.autoRetryEnabled&&!a.autoRetry.enableMaxAttempts&&(b.autoRetryMaxAttempts=0),a.update?b.$update(k,l):b.$save({channelId:""},k,l)},a.cancel=function(){b.dismiss("cancel")},a.validateFormChannels=function(){switch(f.AlertReset("hasErrors"),c.cancel(a.clearValidation),a.ngError.hasErrors=!1,a.$broadcast("parentSaveRouteAndCheckRouteWarnings"),a.$broadcast("parentSaveUrlRewriteAndCheckUrlRewriteWarnings"),a.channel.name||(a.ngError.name=!0,a.ngError.basicInfoTab=!0,a.ngError.hasErrors=!0),a.channel.type){case"tcp":a.channel.tcpHost||(a.ngError.tcpHost=!0,a.ngError.hasErrors=!0),(!a.channel.tcpPort||isNaN(a.channel.tcpPort))&&(a.ngError.tcpPort=!0,a.ngError.hasErrors=!0);break;case"tls":a.channel.tcpHost||(a.ngError.tcpHost=!0,a.ngError.hasErrors=!0),(!a.channel.tcpPort||isNaN(a.channel.tcpPort))&&(a.ngError.tcpPort=!0,a.ngError.hasErrors=!0);break;case"polling":a.channel.pollingSchedule||(a.ngError.pollingSchedule=!0,a.ngError.hasErrors=!0)}switch("private"===a.channel.authType&&(a.channel.allow&&0!==a.channel.allow.length||(a.ngError.allow=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0)),("tcp"===a.channel.type||"tls"===a.channel.type)&&(a.channel.urlPattern="_"+a.channel.type,a.urlPattern.regex=!1),a.channel.urlPattern||(a.ngError.urlPattern=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0),a.matching.showRequestMatching||(a.matching.contentMatching="No matching",a.channel.matchContentRegex=null,a.channel.matchContentXpath=null,a.channel.matchContentValue=null,a.channel.matchContentJson=null),a.matching.contentMatching){case"RegEx matching":a.channel.matchContentRegex||(a.ngError.matchContentRegex=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0);break;case"XML matching":a.channel.matchContentXpath||(a.ngError.matchContentXpath=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0),a.channel.matchContentValue||(a.ngError.matchContentValue=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0);break;case"JSON matching":a.channel.matchContentJson||(a.ngError.matchContentJson=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0),a.channel.matchContentValue||(a.ngError.matchContentValue=!0,a.ngError.requestMatchingTab=!0,a.ngError.hasErrors=!0)}a.ngError.hasRouteWarnings&&(a.ngError.routesTab=!0,a.ngError.hasErrors=!0),a.ngError.hasUrlRewritesWarnings&&(a.ngError.dataControlTab=!0,a.ngError.hasErrors=!0),a.channel.autoRetryEnabled&&((!a.channel.autoRetryPeriodMinutes||a.channel.autoRetryPeriodMinutes<=0)&&(a.ngError.autoRetryPeriodMinutes=!0,a.ngError.dataControlTab=!0,a.ngError.hasErrors=!0),a.autoRetry.enableMaxAttempts&&(!a.channel.autoRetryMaxAttempts||a.channel.autoRetryMaxAttempts<=0)&&(a.ngError.maxAttempts=!0,a.ngError.dataControlTab=!0,a.ngError.hasErrors=!0)),a.ngError.hasErrors&&(a.clearValidation=c(function(){a.ngError={},f.AlertReset("hasErrors"),a.$broadcast("parentCheckRouteWarnings")},5e3),f.AlertAddMsg("hasErrors","danger",a.validationFormErrorsMsg))},a.submitFormChannels=function(){a.ngError={},f.AlertReset("hasErrors"),a.validateFormChannels(),a.ngError.hasErrors===!1&&a.saveOrUpdate(a.channel)}}]),app.controller("channelBasicInfoCtrl",["$scope","$timeout","$interval","Api","Notify","Alerting",function(a,b,c,d,e,f){var g=function(b){a.aboutInfo.serverTime=getTimeForTimezone(b)},h=function(b){a.aboutInfo=b,a.aboutInfo.serverTimezoneOffset=getTimezoneOffset(b.serverTimezone),g(b.serverTimezone),a.clock=c(function(){g(b.serverTimezone)},1e3)},i=function(a){f.AlertAddServerMsg(a.status)};d.About.get(h,i);var j=function(){a.channel.$promise.then(function(){var b=a.channel.urlPattern.length;if(0===a.channel.urlPattern.indexOf("^")&&a.channel.urlPattern.indexOf("$")===b-1){var c=a.channel.urlPattern;a.channel.urlPattern=c.slice(1,-1)}else a.urlPattern.regex=!1})};a.manuallyTriggerChannel=function(){f.AlertReset("manualTrigger"),d.TriggerPollingChannels.save({channelId:a.channel._id},{_id:a.channel._id},function(){f.AlertAddMsg("manualTrigger","success","Channel Triggered"),b(function(){f.AlertReset("manualTrigger")},5e3)})},a.update||a.channelDuplicate?j():(a.channel.type="http",a.channel.authType="private",a.channel.status="enabled"),a.$on("$destroy",function(){angular.isDefined(a.clock)&&c.cancel(a.clock)})}]),app.controller("channelRequestMatchingCtrl",["$scope","Api",function(a,b){a.taglistClientRoleOptions=[],a.taglistUserRoleOptions=[],a.$watch("users",function(){angular.forEach(a.users,function(b){angular.forEach(b.groups,function(b){-1===a.taglistUserRoleOptions.indexOf(b)&&a.taglistUserRoleOptions.push(b)})})}),b.Clients.query(function(b){angular.forEach(b,function(b){-1===a.taglistClientRoleOptions.indexOf(b.clientID)&&a.taglistClientRoleOptions.push(b.clientID),angular.forEach(b.roles,function(b){-1===a.taglistClientRoleOptions.indexOf(b)&&a.taglistClientRoleOptions.push(b)})})},function(){}),a.update&&a.channel.$promise.then(function(){a.channel.matchContentRegex&&(a.matching.contentMatching="RegEx matching"),a.channel.matchContentJson&&(a.matching.contentMatching="JSON matching"),a.channel.matchContentXpath&&(a.matching.contentMatching="XML matching"),(a.channel.matchContentRegex||a.channel.matchContentJson||a.channel.matchContentXpath)&&(a.matching.showRequestMatching=!0)})}]),app.controller("channelUserAccessCtrl",["$scope",function(a){a.taglistUserRoleOptions=[],a.$watch("users",function(){angular.forEach(a.users,function(b){angular.forEach(b.groups,function(b){-1===a.taglistUserRoleOptions.indexOf(b)&&a.taglistUserRoleOptions.push(b)})})})}]),app.controller("channelRoutesCtrl",["$scope","$timeout","Api","Alerting",function(a,b,c,d){a.update||(a.channel.routes=[]),a.selected={},a.mediatorRoutes=[],a.routeAddEdit=!1,c.Mediators.query(function(b){angular.forEach(b,function(b){angular.forEach(b.endpoints,function(c){a.mediatorRoutes.push({fullName:b.name+" - "+c.name,mediator:b.urn,endpoint:c})})})},function(){}),c.Keystore.query({type:"ca"},function(b){a.trustedCerts=[],angular.forEach(b,function(b){a.trustedCerts.push({_id:b._id,commonName:"cn="+b.commonName})})},function(){}),a.resetRouteErrors=function(){a.ngErrorRoute={},d.AlertReset("route"),d.AlertReset("hasErrorsRoute")},a.saveRoute=function(b){a.validateFormRoutes(),a.ngErrorRoute.hasErrors===!1?("undefined"!=typeof b&&null!==b&&a.channel.routes.splice(b,1),a.channel.routes.push(a.newRoute),a.routeAddEdit=!1,a.checkRouteWarnings()):a.ngError.hasRouteWarnings=!0},a.removeRoute=function(b){a.channel.routes.splice(b,1),a.checkRouteWarnings()},a.addEditRoute=function(b,c,d){a.resetRouteErrors(),a.oldRouteIndex=null;var e;"new"===b?(a.routeAddEdit=!0,e=!1,0===a.channel.routes.length&&(e=!0),a.newRoute={name:"",secured:!1,host:"",port:"",path:"",pathTransform:"",primary:e,username:"",password:"",type:"http",status:"enabled",forwardAuthHeader:!1}):"edit"===b&&(a.routeAddEdit=!0,a.newRoute=angular.copy(c),a.oldRouteIndex=d)},a.addRouteFromMediator=function(){a.resetRouteErrors(),a.oldRouteIndex=null,a.routeAddEdit=!1;var b=!1,c="",d=!1,e="",f="",g="",h="",i="",j="",k="http",l=!1;a.selected.mediatorRoute.endpoint.name&&(c=a.selected.mediatorRoute.endpoint.name),a.selected.mediatorRoute.endpoint.secured&&(d=a.selected.mediatorRoute.endpoint.secured),a.selected.mediatorRoute.endpoint.host&&(e=a.selected.mediatorRoute.endpoint.host),a.selected.mediatorRoute.endpoint.port&&(f=a.selected.mediatorRoute.endpoint.port),a.selected.mediatorRoute.endpoint.path&&(g=a.selected.mediatorRoute.endpoint.path),a.selected.mediatorRoute.endpoint.pathTransform&&(h=a.selected.mediatorRoute.endpoint.pathTransform),a.selected.mediatorRoute.endpoint.username&&(i=a.selected.mediatorRoute.endpoint.username),a.selected.mediatorRoute.endpoint.password&&(j=a.selected.mediatorRoute.endpoint.password),a.selected.mediatorRoute.endpoint.type&&(k=a.selected.mediatorRoute.endpoint.type),a.selected.mediatorRoute.endpoint.forwardAuthHeader&&(l=a.selected.mediatorRoute.endpoint.forwardAuthHeader),0===a.channel.routes.length&&(b=!0),a.channel.routes.push({name:c,secured:d,host:e,port:f,path:g,pathTransform:h,primary:b,username:i,password:j,type:k,status:"enabled",forwardAuthHeader:l})},a.cancelRouteAddEdit=function(){b.cancel(a.clearValidationRoute),a.resetRouteErrors(),a.checkRouteWarnings(),a.routeAddEdit=!1},a.onRouteDisable=function(a){a.primary=!1},a.validateFormRoutes=function(){a.resetRouteErrors(),b.cancel(a.clearValidationRoute),a.ngErrorRoute={},a.ngErrorRoute.hasErrors=!1,a.newRoute.name||(a.ngErrorRoute.name=!0,a.ngErrorRoute.hasErrors=!0),a.newRoute.host||(a.ngErrorRoute.host=!0,a.ngErrorRoute.hasErrors=!0);var c=a.checkIsPortValid(a.newRoute.port);c&&(a.ngErrorRoute.port=!0,a.ngErrorRoute.portError=c,a.ngErrorRoute.hasErrors=!0);var e=a.checkPathTransformPathSet(a.newRoute);e&&(a.ngErrorRoute.pathTransform=!0,a.ngErrorRoute.pathTransformError=e,a.ngErrorRoute.hasErrors=!0),a.ngErrorRoute.hasErrors&&(a.clearValidationRoute=b(function(){a.resetRouteErrors(),a.checkRouteWarnings()},5e3),d.AlertAddMsg("hasErrorsRoute","danger",a.validationFormErrorsMsg))},a.checkIsPortValid=function(a){return""===a||void 0===a?"This field is required!":isNaN(a)?"Only numbers allowed!":0>=a||a>65536?"Not in valid port range!":void 0},a.checkPathTransformPathSet=function(a){return a.path&&a.pathTransform?"Cant supply both!":void 0},a.noRoutes=function(){return a.channel.routes&&0!==a.channel.routes.length?!1:(d.AlertAddMsg("route","warning","You must supply atleast one route."),!0)};var e=function(a){return"undefined"==typeof a.status||null===a.status||"enabled"===a.status};a.noPrimaries=function(){if(a.channel.routes)for(var b=0;b<a.channel.routes.length;b++)if(e(a.channel.routes[b])&&a.channel.routes[b].primary===!0)return!1;return d.AlertAddMsg("route","warning","At least one of your enabled routes must be set to primary."),!0},a.multiplePrimaries=function(){if(a.channel.routes)for(var b=a.channel.routes,c=0,f=0;f<b.length;f++)if(e(b[f])&&b[f].primary===!0&&c++,c>1)return d.AlertAddMsg("route","warning","You cannot have multiple primary routes."),!0;return!1},a.$on("parentSaveRouteAndCheckRouteWarnings",function(){a.routeAddEdit===!0?a.saveRoute(a.oldRouteIndex):a.checkRouteWarnings()}),a.$on("parentCheckRouteWarnings",function(){a.checkRouteWarnings()}),a.checkRouteWarnings=function(){a.resetRouteErrors();var b=a.noRoutes(),c=a.noPrimaries(),d=a.multiplePrimaries();(b||c||d)&&(a.ngError.hasRouteWarnings=!0)},a.update?a.channel.$promise.then(function(){a.checkRouteWarnings()}):a.checkRouteWarnings()}]),app.controller("channelDataControlCtrl",["$scope","$timeout","Api","Alerting",function(a,b,c,d){a.update||(a.channel.requestBody=!0,a.channel.responseBody=!0),a.update?a.channel.$promise.then(function(){"undefined"==typeof a.channel.rewriteUrlsConfig&&(a.channel.rewriteUrlsConfig=[],a.channel.rewriteUrls=!1,a.channel.addAutoRewriteRules=!0)}):(a.channel.rewriteUrlsConfig=[],a.channel.rewriteUrls=!1,a.channel.addAutoRewriteRules=!0),a.urlRewriteAddEdit=!1,a.resetUrlRewriteErrors=function(){a.ngErrorUrlRewrite={},d.AlertReset("urlRewrite"),d.AlertReset("hasErrorsUrlRewrite")},a.saveUrlRewrite=function(b){a.validateFormUrlRewrites(),a.ngErrorUrlRewrite.hasErrors===!1?("undefined"!=typeof b&&null!==b&&a.channel.rewriteUrlsConfig.splice(b,1),a.channel.rewriteUrlsConfig.push(a.newUrlRewrite),a.urlRewriteAddEdit=!1,a.checkUrlRewriteWarnings()):a.ngError.hasUrlRewritesWarnings=!0},a.removeUrlRewrite=function(b){a.channel.rewriteUrlsConfig.splice(b,1),a.checkUrlRewriteWarnings()},a.addEditUrlRewrite=function(b,c,d){a.resetUrlRewriteErrors(),a.oldUrlRewriteIndex=null,"new"===b?(a.urlRewriteAddEdit=!0,a.newUrlRewrite={fromHost:"",fromPort:"",toHost:"",toPort:"",pathTransform:""}):"edit"===b&&(a.urlRewriteAddEdit=!0,a.newUrlRewrite=angular.copy(c),a.oldUrlRewriteIndex=d)},a.cancelUrlRewriteAddEdit=function(){b.cancel(a.clearValidationUrlRewrite),a.resetUrlRewriteErrors(),a.checkUrlRewriteWarnings(),a.urlRewriteAddEdit=!1},a.validateFormUrlRewrites=function(){a.resetUrlRewriteErrors(),b.cancel(a.clearValidationUrlRewrite),a.ngErrorUrlRewrite={},a.ngErrorUrlRewrite.hasErrors=!1,a.newUrlRewrite.fromHost||(a.ngErrorUrlRewrite.fromHost=!0,a.ngErrorUrlRewrite.hasErrors=!0);var c=a.checkIsPortValid(a.newUrlRewrite.fromPort);c&&(a.ngErrorUrlRewrite.fromPort=!0,a.ngErrorUrlRewrite.portError=c,a.ngErrorUrlRewrite.hasErrors=!0),a.newUrlRewrite.toHost||(a.ngErrorUrlRewrite.toHost=!0,a.ngErrorUrlRewrite.hasErrors=!0);var e=a.checkIsPortValid(a.newUrlRewrite.toPort);e&&(a.ngErrorUrlRewrite.toPort=!0,a.ngErrorUrlRewrite.portError=e,a.ngErrorUrlRewrite.hasErrors=!0),a.ngErrorUrlRewrite.hasErrors&&(a.clearValidationUrlRewrite=b(function(){a.resetUrlRewriteErrors(),a.checkUrlRewriteWarnings()},5e3),d.AlertAddMsg("hasErrorsUrlRewrite","danger",a.validationFormErrorsMsg))},a.checkIsPortValid=function(a){return""===a||void 0===a?"This field is required!":isNaN(a)?"Only numbers allowed!":0>=a||a>65536?"Not in valid port range!":void 0},a.$on("parentSaveUrlRewriteAndCheckUrlRewriteWarnings",function(){a.urlRewriteAddEdit===!0?a.saveUrlRewrite(a.oldUrlRewriteIndex):a.checkUrlRewriteWarnings()}),a.$on("parentCheckUrlRewriteWarnings",function(){a.checkUrlRewriteWarnings()}),a.checkUrlRewriteWarnings=function(){a.resetUrlRewriteErrors()},a.checkUrlRewriteWarnings()}]),app.controller("channelAlertsCtrl",["$scope","Api",function(a,b){a.$watch("users",function(){a.usersMap={},angular.forEach(a.users,function(b){a.usersMap[b.email]=b.firstname+" "+b.surname+" ("+b.email+")"})}),a.alertGroups=b.ContactGroups.query(function(){a.groupsMap={},angular.forEach(a.alertGroups,function(b){a.groupsMap[b._id]=b.group})},function(){}),a.channelAlertsBackup=null,a.newAlert={},a.addAlert=function(b){a.channel.alerts||(a.channel.alerts=[]),a.channel.alerts.push(angular.copy(b)),a.channelAlertsBackup=null,a.newAlert.status=null,a.newAlert.failureRate=null,a.newAlert.groups=[],a.newAlert.users=[]},a.editAlert=function(b,c){a.channel.alerts.splice(b,1),null!==a.channelAlertsBackup&&a.channel.alerts.push(angular.copy(a.channelAlertsBackup)),a.channelAlertsBackup=angular.copy(c),a.newAlert=c},a.removeAlert=function(b){a.channel.alerts.splice(b,1)},a.isAlertValid=function(){if(!a.newAlert.condition)return!1;if("status"===a.newAlert.condition&&!a.newAlert.status){if(!a.newAlert.status)return!1;if(3!==a.newAlert.status.length)return!1}return a.newAlert.users&&0!==a.newAlert.users.length||a.newAlert.groups&&0!==a.newAlert.groups.length?!0:!1},a.channelAlertsUsersBackup=null,a.newAlertUser={},a.addAlertUser=function(b){a.newAlert.users||(a.newAlert.users=[]),a.newAlert.users.push(angular.copy(b)),a.channelAlertsUsersBackup=null,a.newAlertUser.user="",a.newAlertUser.method="",a.newAlertUser.maxAlerts=""},a.editAlertUser=function(b,c){a.newAlert.users.splice(b,1),null!==a.channelAlertsUsersBackup&&a.newAlert.users.push(angular.copy(a.channelAlertsUsersBackup)),a.channelAlertsUsersBackup=angular.copy(c),a.newAlertUser=c},a.removeAlertUser=function(b){a.newAlert.users.splice(b,1)},a.isAlertUserValid=function(){return a.newAlertUser.user&&a.newAlertUser.method&&a.newAlertUser.maxAlerts?!0:!1},a.newAlertGroup={},a.newAlert.groups=[],a.addAlertGroup=function(b){-1===a.newAlert.groups.indexOf(b.group)&&a.newAlert.groups.push(angular.copy(b.group)),a.newAlertGroup.group=""},a.removeAlertGroup=function(b){a.newAlert.groups.splice(b,1)},a.isAlertGroupValid=function(){return a.newAlertGroup.group?!0:!1}}]),angular.module("openhimConsoleApp").controller("ChannelMonitoringCtrl",["$scope","$modal","$interval","$location","$routeParams","Api","Alerting","Metrics",function(a,b,c,d,e,f,g,h){function i(b){if(0===b.length)g.AlertAddMsg("load","warning",m),g.AlertAddMsg("responseTime","warning",m);else{var c=function(a){return a.toFixed(2)};a.transactionLoadData=h.buildLineChartData(a.selectedDateType,b,"total"),a.transactionResponseTimeData=h.buildLineChartData(a.selectedDateType,b,"avgResp",c)}}function j(a){g.AlertAddMsg("load","danger","Transaction Load Error: "+a.status+" "+a.data),g.AlertAddMsg("responseTime","danger","Transaction Load Error: "+a.status+" "+a.data)}function k(){f.MetricsTimeseriesChannel.query({type:a.selectedDateType.type,channelId:e.channelId,startDate:moment(a.selectedDateType.from).format(),endDate:moment(a.selectedDateType.until).format()},i,j)}function l(){f.MetricsChannels.query({channelId:e.channelId,startDate:moment(a.selectedDateType.from).format(),endDate:moment(a.selectedDateType.until).format()},s,t)}var m="There has been no transactions received for the queried timeframe",n=function(b){a.channel=b},o=function(a){g.AlertAddServerMsg(a.status)};f.Channels.get({channelId:e.channelId},n,o),a.selectedDateType={period:"1d"};var p=c(function(){a.updateMetrics()},5e3),q=function(b){for(var c=[],d=0;d<b.length;d++)c.push({label:b[d].label,value:b[d].value});a.channelsBarData={data:c,xkey:"label",ykeys:["value"],labels:["Total"]}},r=function(b){for(var c=[],d=[],e=0;e<b.length;e++)c.push({label:b[e].label,value:b[e].percent}),d.push(b[e].color);a.channelsDonutData={data:c,colors:d}},s=function(a){if(0===a.length)g.AlertAddMsg("status","warning",m);else{var b,c,d=[],e=0;e+=parseInt(a[0].processing),e+=parseInt(a[0].failed),e+=parseInt(a[0].completed),e+=parseInt(a[0].completedWErrors),e+=parseInt(a[0].successful),0!==parseInt(a[0].processing)&&(b=parseInt(a[0].processing),c=(100/e*b).toFixed(2),d.push({label:"Processing",value:b,percent:c,color:"#777777"})),0!==parseInt(a[0].failed)&&(b=parseInt(a[0].failed),c=(100/e*b).toFixed(2),d.push({label:"Failed",value:b,percent:c,color:"#d9534f"})),0!==parseInt(a[0].completed)&&(b=parseInt(a[0].completed),c=(100/e*b).toFixed(2),d.push({label:"Completed",value:b,percent:c,color:"#f0ad4e"})),0!==parseInt(a[0].completedWErrors)&&(b=parseInt(a[0].completedWErrors),c=(100/e*b).toFixed(2),d.push({label:"Completed With Error (s)",value:b,percent:c,color:"#5bc0de"})),0!==parseInt(a[0].successful)&&(b=parseInt(a[0].successful),c=(100/e*b).toFixed(2),d.push({label:"Successful",value:b,percent:c,
color:"#5cb85c"})),q(d),r(d)}},t=function(a){g.AlertAddMsg("status","danger","Transaction Channels Error: "+a.status+" "+a.data)};a.updateMetrics=function(){g.AlertReset("load"),g.AlertReset("responseTime"),g.AlertReset("status"),h.refreshDatesForSelectedPeriod(a.selectedDateType),k(),l()},a.updateMetrics(),a.$on("$destroy",function(){angular.isDefined(p)&&(c.cancel(p),p=void 0)})}]),angular.module("openhimConsoleApp").controller("ClientsCtrl",["$rootScope","$scope","$modal","$interval","Api","Alerting","Notify",function(a,b,c,d,e,f,g){var h=function(a){f.AlertAddServerMsg(a.status)},i=function(a){b.clients=a,0===a.length&&f.AlertAddMsg("bottom","warning","There are currently no clients created")},j=function(){var a=function(a){b.roles=a,0===a.length?f.AlertAddMsg("bottom","warning","There are currently no roles created"):f.AlertReset("bottom")};e.Roles.query(a,h),b.$on("rolesChanged",function(){e.Roles.query(a,h)})};e.Clients.query(i,h),b.$on("clientsChanged",function(){e.Clients.query(i,h),j()}),b.addClient=function(){f.AlertReset(),b.serverRestarting=!1,c.open({templateUrl:"views/clientsmodal.html",controller:"ClientsModalCtrl",resolve:{client:function(){}}})},b.editClient=function(a){f.AlertReset(),b.serverRestarting=!1,c.open({templateUrl:"views/clientsmodal.html",controller:"ClientsModalCtrl",resolve:{client:function(){return a}}})},b.addNewRole=!1,b.newRoles=[],b.newRolesIndex=0;var k=function(a,b,c,d){var f=function(){d(null,c)},g=function(a){d(a)};switch(a){case"update":e.Roles.update(b,c,f,g);break;case"save":e.Roles.save(b,c,f,g);break;case"remove":e.Roles.remove(b,c,f,g)}},l=function(a){b.channels=a,0===a.length?f.AlertAddMsg("bottom","warning","There are currently no channels created"):f.AlertReset("bottom")};e.Channels.query(l,h),b.$watch("channels",function(a){a&&j()});var m=function(){b.clientRoles={},angular.forEach(b.roles,function(a){for(var c=0;c<a.clients.length;c++)b.clientRoles[a.clients[c].clientID+a.name]=!0})},n=function(){b.channelRoles={},angular.forEach(b.channels,function(a){angular.forEach(b.roles,function(c){for(var d=0;d<c.channels.length;d++)c.channels[d]._id===a._id&&(b.channelRoles[a.name+c.name]=!0)})})},o=function(){b.$watch("roles",function(a){a&&(m(),n(),angular.forEach(b.roles,function(a){a.displayName=a.name}))})};b.$watch("clients",function(a){a&&o()});var p=function(a){return a?(f.AlertReset(),f.AlertAddMsg("role","danger","An error has occurred while saving the roles' details: #"+a.status+" - "+a.data)):(f.AlertReset(),void g.notify("clientsChanged"))};b.assignRoleToClient=function(a,c,d){c.clients||(c.clients=[]),c.clients.push({_id:a._id,name:a.clientID}),b.clientRoles[a.clientID+c.name]=!0;var e=angular.copy(c);e.name=void 0,d&&k("update",{name:c.name},e,p)},b.removeRoleFromClient=function(a,c,d){b.clientRoles[a.clientID+c.name]=!1;for(var e=-1,f=0;f<c.clients.length;f++)if(c.clients[f].clientID===a.clientID){e=f;break}c.clients.splice(e,1);var g=angular.copy(c);g.name=void 0,d&&k("update",{name:c.name},g,p)},b.toggleEditClients=function(){b.editClients=b.editClients===!0?!1:!0},b.assignRoleToChannel=function(a,c,d){c.channels||(c.channels=[]),c.channels.push({_id:a._id,name:a.name}),b.channelRoles[a.name+c.name]=!0;var e=angular.copy(c);e.name=void 0,d&&k("update",{name:c.name},e,p)},b.removeAssignRoleFromChannel=function(a,c,d){b.channelRoles[a.name+c.name]=!1;for(var e=-1,f=0;f<c.channels.length;f++)if(c.channels[f].name===a.name){e=f;break}c.channels.splice(e,1);var g=angular.copy(c);g.name=void 0,d&&k("update",{name:c.name},g,p)},b.nameSaved=[],b.changeRoleName=function(a){try{angular.forEach(b.roles,function(b){if(b.name===a.displayName)throw"break"});var c={};c.name=a.displayName,b.nameSaved[a.displayName]=!0,k("update",{name:a.name},c,p)}catch(d){b.nameSaved[a.displayName]=!0}},b.toggleEditRoleNames=function(){b.editRoleNames=b.editRoleNames===!0?!1:!0,b.nameSaved=[]},b.addRole=function(){f.AlertReset(),b.newRoles.push({idName:"Role"+b.newRolesIndex,index:b.newRolesIndex++,name:b.newRoles.name})},b.assignClientToNewRole=function(a,c){return c.name?(c.clients||(c.clients=[]),c.clients.push({_id:a._id,name:a.clientID}),void(b.clientRoles[a.clientID+c.name]=!0)):(f.AlertReset(),f.AlertAddMsg("role","danger","Please name the Role before assigning Clients/Channels"))},b.assignNewRoleToChannel=function(a,c){return c.name?(c.channels||(c.channels=[]),c.channels.push({_id:a._id,name:a.name}),void(b.channelRoles[a.name+c.name]=!0)):(f.AlertReset(),f.AlertAddMsg("role","danger","Please name the Role before assigning Clients/Channels"))};var q=function(a,c){return a?(f.AlertReset(),f.AlertAddMsg("role","danger","Saving new role failed: "+a.data)):(f.AlertReset(),f.AlertAddMsg("role","success",'Role with name "'+c.name+'" successfully created.'),g.notify("clientsChanged"),void b.removeNewRole(c))};b.saveNewRole=function(a){k("save",{name:null},a,q)},b.removeNewRole=function(a){for(var c=-1,d=0;d<b.newRoles.length;d++)if(b.newRoles[d].name===a.name){c=d;break}b.newRoles.splice(c,1)};var r=function(a){return a?(f.AlertReset(),f.AlertAddMsg("role","danger","An error has occurred while deleting the role: #"+a.status+" - "+a.data)):(g.notify("rolesChanged"),g.notify("clientsChanged"),f.AlertReset(),void f.AlertAddMsg("role","success","The role has been deleted successfully"))},s=function(a){k("remove",{name:a.name},null,r);for(var c=-1,d=0;d<b.roles.length;d++)if(b.roles[d].name===a.name){c=d;break}b.roles.splice(c,1)},t=function(a,d,e){f.AlertReset(),b.serverRestarting=!1;var g={title:"Delete "+d,button:"Delete",message:'Are you sure you wish to delete the "'+d+'": "'+a.name+'"?'},h=c.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return g}}});h.result.then(function(){e()},function(){})},u=function(){b.clients=e.Clients.query(),f.AlertReset(),f.AlertAddMsg("client","success","The client has been deleted successfully")},v=function(a){f.AlertReset(),f.AlertAddMsg("client","danger","An error has occurred while deleting the client: #"+a.status+" - "+a.data)};b.confirmRoleDelete=function(a){t(a,"Role",function(){s(a)})},b.confirmClientDelete=function(a){t(a,"Client",function(){a.$remove(u,v)})}}]),angular.module("openhimConsoleApp").controller("ClientsModalCtrl",["$rootScope","$scope","$modalInstance","$timeout","Api","Notify","Alerting","client",function(a,b,c,d,e,f,g,h){b.temp={},b.roles={},b.formData={},b.formData.assigned={},b.formData.newClientRole=null;var i=function(){for(var a=0;a<b.client.roles.length;a++)b.formData.assigned[b.client.roles[a]]=!0};b.$watch("client",function(){e.Roles.query(function(a){b.roles=a,b.client.name?i():b.client.roles=[]})});var j=function(a){for(var c=-1,d=0;d<b.client.roles.length;d++)if(b.client.roles[d]===a){c=d;break}b.client.roles.splice(c,1)};b.toggleAssignedRoles=function(a){b.formData.assigned[a]?(b.formData.assigned[a]=!1,j(a)):(b.formData.assigned[a]=!0,b.client.roles.push(a))};var k=function(a){for(var c=!1,d=0;d<b.roles.length;d++)b.roles[d].name===a&&(c=!0);return c};e.Clients.query(function(a){b.clients=a});var l=function(a){for(var c=!1,d=0;d<b.clients.length;d++)b.clients[d].clientID===a&&(c=!0);return c};b.createNewRole=function(){var a=b.formData.newClientRole;a&&(k(a)||l(a)?b.formData.duplicateNewRole=!0:(b.formData.duplicateNewRole=!1,b.client.roles.push(a),b.roles.push({name:a}),b.formData.assigned[a]=!0,b.formData.newClientRole=null))},e.Keystore.query({type:"ca"},function(a){b.certs=a}),h?(b.update=!0,b.client=e.Clients.get({clientId:h._id},function(){})):(b.update=!1,b.client=new e.Clients);var m=function(){f.notify("clientsChanged"),f.notify("rolesChanged"),c.close()},n=function(){g.AlertAddMsg("client","success","The client has been saved successfully"),m()},o=function(a){g.AlertAddMsg("client","danger","An error has occurred while saving the clients' details: #"+a.status+" - "+a.data),m()},p=function(a){b.clientBackup=angular.copy(a),b.update?a.$update(n,o):a.$save({clientId:""},n,o)},q=function(a,b,c){"undefined"!=typeof c&&null!==c&&(a.passwordSalt=c),a.passwordHash=b,p(a)},r=function(a,b){var c=CryptoJS.lib.WordArray.random(16).toString(),d=CryptoJS.algo.SHA512.create();d.update(b),d.update(c);var e=d.finalize();a.passwordAlgorithm="sha512",q(a,e.toString(CryptoJS.enc.Hex),c)};b.save=function(a,b){b?r(a,b):p(a)},b.cancel=function(){c.dismiss("cancel")},b.validateFormClients=function(){g.AlertReset("hasErrors"),d.cancel(b.clearValidation),b.ngError={},b.ngError.hasErrors=!1,b.client.clientID||(b.ngError.clientID=!0,b.ngError.hasErrors=!0),b.client.name||(b.ngError.name=!0,b.ngError.hasErrors=!0),b.client.roles&&0!==b.client.roles.length||(b.ngError.roles=!0,b.ngError.hasErrors=!0),b.update===!1?b.client.certFingerprint||b.temp.password||(b.ngError.certFingerprint=!0,b.ngError.password=!0,b.ngError.hasErrors=!0):b.client.certFingerprint||b.temp.password||b.client.passwordHash||(b.ngError.certFingerprint=!0,b.ngError.password=!0,b.ngError.hasErrors=!0),b.temp.password&&(b.temp.passwordConfirm&&b.temp.password===b.temp.passwordConfirm||(b.ngError.passwordConfirm=!0,b.ngError.hasErrors=!0)),b.ngError.hasErrors&&(b.clearValidation=d(function(){b.ngError={}},5e3),g.AlertAddMsg("hasErrors","danger",b.validationFormErrorsMsg))},b.submitFormClients=function(){b.validateFormClients(),b.ngError.hasErrors===!1&&b.save(b.client,b.temp.password)}}]),angular.module("openhimConsoleApp").controller("MonitoringCtrl",["$scope",function(a){a.setSomething=!0}]),angular.module("openhimConsoleApp").controller("UsersCtrl",["$scope","$modal","$window","Api","Alerting","Notify",function(a,b,c,d,e,f){var g=function(b){a.users=b,0===b.length&&(e.AlertReset(),e.AlertAddMsg("bottom","warning","There are currently no users created")),d.Channels.query(function(c){var d=[],e=[];angular.forEach(c,function(a){("undefined"==typeof a.status||"deleted"!==a.status)&&e.push({id:a._id,name:a.name})}),angular.forEach(b,function(a){var b=[],e=[],f=[];angular.forEach(c,function(c){angular.forEach(a.groups,function(a){(c.txViewAcl.indexOf(a)>=0||"admin"===a)&&b.push(c._id),(c.txViewFullAcl.indexOf(a)>=0||"admin"===a)&&f.push(c._id),(c.txRerunAcl.indexOf(a)>=0||"admin"===a)&&e.push(c._id)})}),d.push({user:a,allowedChannels:b,allowedChannelsBody:f,allowedChannelsRerun:e})}),a.usersChannelsMatrix={},a.usersChannelsMatrix.channels=e,a.usersChannelsMatrix.users=d},function(){})},h=function(a){e.AlertReset(),e.AlertAddServerMsg(a.status)};d.Users.query(g,h),a.$on("usersChanged",function(){d.Users.query(g,h)}),a.isAllowedChannel=function(a,b){return b.indexOf(a)>=0?!0:!1},a.addUser=function(){e.AlertReset(),b.open({templateUrl:"views/usersmodal.html",controller:"UsersModalCtrl",resolve:{user:function(){}}})},a.editUser=function(a){e.AlertReset(),b.open({templateUrl:"views/usersmodal.html",controller:"UsersModalCtrl",resolve:{user:function(){return a}}})},a.confirmDelete=function(c){e.AlertReset();var d={title:"Delete User",button:"Delete",message:'Are you sure you wish to delete the user "'+c.firstname+" "+c.surname+'"?'},f=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return d}}});f.result.then(function(){a.sessionUserDeleted=!1;var b=localStorage.getItem("loggedOnUser");b=JSON.parse(b),b.email===c.email&&(a.sessionUserDeleted=!0),c.$remove(i,j)},function(){})};var i=function(){return a.sessionUserDeleted?void(c.location="#/logout"):(a.users=d.Users.query(),e.AlertReset(),f.notify("usersChanged"),void e.AlertAddMsg("top","success","The user has been deleted successfully"))},j=function(a){e.AlertReset(),e.AlertAddMsg("top","danger","An error has occurred while deleting the user: #"+a.status+" - "+a.data)}}]),angular.module("openhimConsoleApp").controller("UsersModalCtrl",["$http","$scope","$modalInstance","$timeout","Api","login","Notify","Alerting","user",function(a,b,c,d,e,f,g,h,i){b.update=!1,b.taglistUserRoleOptions=[],b.temp={},e.Channels.query(function(a){b.channels=a,b.primaryRoutes=[],b.secondaryRoutes=[],angular.forEach(a,function(a){angular.forEach(a.routes,function(a){a.primary?b.primaryRoutes.indexOf(a.name)<0&&b.primaryRoutes.push(a.name):b.secondaryRoutes.indexOf(a.name)<0&&b.secondaryRoutes.push(a.name)})})},function(){}),e.Users.query(function(a){angular.forEach(a,function(a){angular.forEach(a.groups,function(a){-1===b.taglistUserRoleOptions.indexOf(a)&&b.taglistUserRoleOptions.push(a)})})},function(){}),i?(b.update=!0,b.user=e.Users.get({email:i.email},function(){b.user.settings||(b.user.settings={}),b.user.settings.list||(b.user.settings.list={})})):(b.user=new e.Users,b.user.settings={},b.user.settings.list={},b.user.settings.filter={},b.user.settings.filter.limit=100);var j=function(){g.notify("usersChanged"),c.close()},k=function(a,b){var c=localStorage.getItem("consoleSession");c=JSON.parse(c),a.email===c.sessionUser?(c.sessionUserSettings=a.settings,localStorage.setItem("consoleSession",JSON.stringify(c)),b?f.login(c.sessionUser,b,function(a){a?(h.AlertAddMsg("top","success","Your details has been saved succesfully and you were logged in with your new credentials"),j()):(h.AlertAddMsg("top","danger","An error has occurred while trying to log you in again with you new credentials"),j())}):(h.AlertAddMsg("top","success","Your details has been saved succesfully"),j())):(h.AlertAddMsg("top","success","The user has been saved successfully"),j())},l=function(a){h.AlertAddMsg("top","danger","An error has occurred while saving the users' details: #"+a.status+" - "+a.data),j()},m=function(a,c){var d=angular.copy(a);b.update?a.$update(function(){k(d,c)},l):a.$save({email:""},k,l)},n=function(a,b,c,d){"undefined"!=typeof c&&null!==c&&(a.passwordSalt=c),a.passwordHash=b,m(a,d)};b.save=function(a,b){if(b){var c=getHashAndSalt(b);a.passwordAlgorithm=c.algorithm,n(a,c.hash,c.salt,b)}else m(a,"")},b.cancel=function(){c.dismiss("cancel")},b.validateFormUsers=function(){h.AlertReset("hasErrors"),d.cancel(b.clearValidation),b.ngError={},b.ngError.hasErrors=!1,b.user.email||(b.ngError.email=!0,b.ngError.hasErrors=!0),b.user.firstname||(b.ngError.firstname=!0,b.ngError.hasErrors=!0),b.user.surname||(b.ngError.surname=!0,b.ngError.hasErrors=!0),b.user.msisdn&&!isValidMSISDN(b.user.msisdn)&&(b.ngError.msisdn=!0,b.ngError.hasErrors=!0),b.user.groups&&0!==b.user.groups.length||(b.ngError.groups=!0,b.ngError.hasErrors=!0),b.update&&b.temp.password&&(b.temp.passwordConfirm&&b.temp.password===b.temp.passwordConfirm||(b.ngError.passwordConfirm=!0,b.ngError.hasErrors=!0)),b.ngError.hasErrors&&(b.clearValidation=d(function(){b.ngError={}},5e3),h.AlertAddMsg("hasErrors","danger",b.validationFormErrorsMsg))},b.submitFormUsers=function(){b.validateFormUsers(),b.ngError.hasErrors===!1&&b.save(b.user,b.temp.password)}}]),angular.module("openhimConsoleApp").controller("TransactionsCtrl",["$scope","$modal","$location","$timeout","$interval","Api","Alerting",function(a,b,c,d,e,f,g){var h=moment(),i=20,j="dont-filter",k="same";a.defaultBulkRerunLimit=1e4,a.loadMoreBtn=!1;var l=!0;a.advancedFilters={},a.advancedFilters.isCollapsed=!0,a.showpage=0,a.checkbox={},a.checkbox.checkAll=!1,a.transactionsSelected=[],a.rerunTransactionsSelected=0,a.settings={},a.settings.list={},a.settings.list.tabview=k,a.settings.list.autoupdate=l,a.settings.filter={},a.settings.filter.limit=i;var m=localStorage.getItem("consoleSession");m=JSON.parse(m),a.consoleSession=m;var n,o=m.sessionUserSettings,p=m.sessionUser,q=0;a.baseIndex=0;var r=5e3;a.settings.filter.transaction={},a.settings.filter.route={},a.settings.filter.orchestration={},a.settings.filter.transaction.wasRerun=j;var s=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},t=function(b){b.limit&&0!==b.limit&&(a.settings.filter.limit=b.limit),s(b.transaction)||(a.settings.filter.transaction=b.transaction),s(b.orchestration)||(a.settings.filter.orchestration=b.orchestration),s(b.route)||(a.settings.filter.route=b.route),a.settings.filter.startDate=b.startDate,a.settings.filter.endDate=b.endDate};angular.equals({},c.search())&&o&&(o.filter&&t(o.filter),o.list&&(a.settings.list.tabview=o.list.tabview,angular.isDefined(o.list.autoupdate)&&(a.settings.list.autoupdate=o.list.autoupdate))),c.search().limit&&(a.settings.filter.limit=c.search().limit),c.search().startDate&&(a.settings.filter.startDate=c.search().startDate),c.search().endDate&&(a.settings.filter.endDate=c.search().endDate),c.search().txWasRerun&&(a.settings.filter.transaction.wasRerun=c.search().txWasRerun),c.search().txStatus&&(a.settings.filter.transaction.status=c.search().txStatus),c.search().txChannel&&(a.settings.filter.transaction.channel=c.search().txChannel),c.search().txStatusCode&&(a.settings.filter.transaction.statusCode=c.search().txStatusCode,a.advancedFilters.isCollapsed=!1),c.search().txHost&&(a.settings.filter.transaction.host=c.search().txHost,a.advancedFilters.isCollapsed=!1),c.search().txPort&&(a.settings.filter.transaction.port=c.search().txPort,a.advancedFilters.isCollapsed=!1),c.search().txPath&&(a.settings.filter.transaction.path=c.search().txPath,a.advancedFilters.isCollapsed=!1),c.search().txParamKey&&(a.settings.filter.transaction.requestParamKey=c.search().txParamKey,a.advancedFilters.isCollapsed=!1),c.search().txParamValue&&(a.settings.filter.transaction.requestParamValue=c.search().txParamValue,a.advancedFilters.isCollapsed=!1),c.search().txClient&&(a.settings.filter.transaction.client=c.search().txClient,a.advancedFilters.isCollapsed=!1),c.search().txPropertyKey&&(a.settings.filter.transaction.propertyKey=c.search().txPropertyKey,a.advancedFilters.isCollapsed=!1),c.search().txPropertyValue&&(a.settings.filter.transaction.propertyValue=c.search().txPropertyValue,a.advancedFilters.isCollapsed=!1),c.search().txHttpMethod&&(a.settings.filter.transaction.method=c.search().txHttpMethod,a.advancedFilters.isCollapsed=!1),c.search().routeStatusCode&&(a.settings.filter.route.statusCode=c.search().routeStatusCode,a.advancedFilters.isCollapsed=!1),c.search().routeHost&&(a.settings.filter.route.host=c.search().routeHost,a.advancedFilters.isCollapsed=!1),c.search().routePort&&(a.settings.filter.route.port=c.search().routePort,a.advancedFilters.isCollapsed=!1),c.search().routePath&&(a.settings.filter.route.path=c.search().routePath,a.advancedFilters.isCollapsed=!1),c.search().routeParamKey&&(a.settings.filter.route.requestParamKey=c.search().routeParamKey,a.advancedFilters.isCollapsed=!1),c.search().routeParamValue&&(a.settings.filter.route.requestParamValue=c.search().routeParamValue,a.advancedFilters.isCollapsed=!1),c.search().orchStatusCode&&(a.settings.filter.orchestration.statusCode=c.search().orchStatusCode,a.advancedFilters.isCollapsed=!1),c.search().orchHost&&(a.settings.filter.orchestration.host=c.search().orchHost,a.advancedFilters.isCollapsed=!1),c.search().orchPort&&(a.settings.filter.orchestration.port=c.search().orchPort,a.advancedFilters.isCollapsed=!1),c.search().orchPath&&(a.settings.filter.orchestration.path=c.search().orchPath,a.advancedFilters.isCollapsed=!1),c.search().orchParamKey&&(a.settings.filter.orchestration.requestParamKey=c.search().orchParamKey,a.advancedFilters.isCollapsed=!1),c.search().orchParamValue&&(a.settings.filter.orchestration.requestParamValue=c.search().orchParamValue,a.advancedFilters.isCollapsed=!1);var u=a.consoleSession.sessionUserGroups;u.indexOf("admin")>=0&&(a.rerunAllowedAdmin=!0),a.channels=f.Channels.query(function(){a.channelsMap={},angular.forEach(a.channels,function(b){a.channelsMap[b._id]={},a.channelsMap[b._id].name=b.name,"undefined"==typeof b.status||"enabled"===b.status?u.indexOf("admin")>=0?a.channelsMap[b._id].rerun=!0:angular.forEach(u,function(c){a.channelsMap[b._id].rerun=b.txRerunAcl.indexOf(c)>=0?!0:!1}):a.channelsMap[b._id].rerun=!1})},function(){}),a.clientsIdNameMap={};var v=function(b){a.clients=b,a.clients.map(function(b){a.clientsIdNameMap[b._id]=b.name})};f.Clients.query(v);var w=function(a,b,c){a[b]=moment(new Date(c)).format()};a.returnFilters=function(){var b,c,d={};if(d.filterPage=a.showpage,d.filterLimit=a.settings.filter.limit,d.filters={},b=a.settings.filter.startDate,c=a.settings.filter.endDate,b||c){var e={};b&&w(e,"$gte",b),c&&w(e,"$lte",c),d.filters["request.timestamp"]=JSON.stringify(e)}var f=a.settings.filter.transaction.status;valueNotEmpty(f)===!0&&(d.filters.status=f);var g=a.settings.filter.transaction.channel;valueNotEmpty(g)===!0&&(d.filters.channelID=g);var h=a.settings.filter.transaction.statusCode;valueNotEmpty(h)===!0&&(d.filters["response.status"]=h);var i=a.settings.filter.transaction.host;valueNotEmpty(i)===!0&&(d.filters["request.host"]=i);var j=a.settings.filter.transaction.port;valueNotEmpty(j)===!0&&(d.filters["request.port"]=j);var k=a.settings.filter.transaction.path;valueNotEmpty(k)===!0&&(d.filters["request.path"]=k);var l=a.settings.filter.transaction.requestParamKey,m=a.settings.filter.transaction.requestParamValue;valueNotEmpty(l)===!0&&(d.filters["request.querystring"]=l,valueNotEmpty(m)===!0&&(d.filters["request.querystring"]+="="+m));var n=a.settings.filter.transaction.client;valueNotEmpty(n)===!0&&(d.filters.clientID=n);var o=a.settings.filter.transaction.wasRerun;valueNotEmpty(o)===!0&&("yes"===o?d.filters["childIDs.0"]=JSON.stringify({$exists:!0}):"no"===o&&(d.filters["childIDs.0"]=JSON.stringify({$exists:!1})));var p=a.settings.filter.transaction.propertyKey,q=a.settings.filter.transaction.propertyValue;valueNotEmpty(p)===!0&&(d.filters.properties={},d.filters.properties[p]=null,valueNotEmpty(q)===!0&&(d.filters.properties[p]=q));var r=a.settings.filter.transaction.method;valueNotEmpty(r)===!0&&(d.filters["request.method"]=r);var s=a.settings.filter.route.statusCode;valueNotEmpty(s)===!0&&(d.filters["routes.response.status"]=s);var t=a.settings.filter.route.host;valueNotEmpty(t)===!0&&(d.filters["routes.request.host"]=t);var u=a.settings.filter.route.port;valueNotEmpty(u)===!0&&(d.filters["routes.request.port"]=u);var v=a.settings.filter.route.path;valueNotEmpty(v)===!0&&(d.filters["routes.request.path"]=v);var x=a.settings.filter.route.requestParamKey,y=a.settings.filter.route.requestParamValue;valueNotEmpty(x)===!0&&(d.filters["routes.request.querystring"]=x,valueNotEmpty(y)===!0&&(d.filters["routes.request.querystring"]+="="+y));var z=a.settings.filter.orchestration.statusCode;valueNotEmpty(z)===!0&&(d.filters["orchestrations.response.status"]=z);var A=a.settings.filter.orchestration.host;valueNotEmpty(A)===!0&&(d.filters["orchestrations.request.host"]=A);var B=a.settings.filter.orchestration.port;valueNotEmpty(B)===!0&&(d.filters["orchestrations.request.port"]=B);var C=a.settings.filter.orchestration.path;valueNotEmpty(C)===!0&&(d.filters["orchestrations.request.path"]=C);var D=a.settings.filter.orchestration.requestParamKey,E=a.settings.filter.orchestration.requestParamValue;return valueNotEmpty(D)===!0&&(d.filters["orchestrations.request.querystring"]=D,valueNotEmpty(E)===!0&&(d.filters["orchestrations.request.querystring"]+="="+E)),d};var x=function(b){a.transactions=b;var d=b.map(function(a){return a._id});sessionStorage.setItem("currTxList",angular.toJson(d)),sessionStorage.setItem("currFilterURL",c.url()),b.length<a.settings.filter.limit?(a.loadMoreBtn=!1,0===b.length&&g.AlertAddMsg("bottom","warning","There are no transactions for the current filters")):a.loadMoreBtn=!0,a.bulkRerun?(a.checkbox.checkAll=!0,a.toggleCheckedAll(),a.settings.filter.startDate&&a.settings.filter.endDate||(a.NoDateRange=!0)):a.resetCheckedItems()},y=function(b){a.loadMoreBtn=!1,g.AlertAddServerMsg(b.status)};a.validateFormFilters=function(){g.AlertReset("hasErrors"),d.cancel(a.clearValidation),a.ngError={},a.ngError.hasErrors=!1,a.settings.filter.transaction.statusCode&&/^\d(\d\d|xx)$/.test(a.settings.filter.transaction.statusCode)===!1&&(a.ngError.txStatusCode=!0,a.ngError.hasErrors=!0),a.settings.filter.route.statusCode&&/^\d(\d\d|xx)$/.test(a.settings.filter.route.statusCode)===!1&&(a.ngError.routeStatusCode=!0,a.ngError.hasErrors=!0),a.settings.filter.orchestration.statusCode&&/^\d(\d\d|xx)$/.test(a.settings.filter.orchestration.statusCode)===!1&&(a.ngError.orchStatusCode=!0,a.ngError.hasErrors=!0),a.ngError.hasErrors&&(a.clearValidation=d(function(){a.ngError={}},5e3),g.AlertAddMsg("hasErrors","danger",a.validationFormErrorsMsg))};var z=function(b,c){moment(b,"YYYY-MM-DD HH:mm:ss:SSSS",!0).isValid()?c():b||a.applyFiltersToUrl()};a.applyStartDate=function(b){z(b,function(){a.applyFiltersToUrl()})},a.applyEndDate=function(b){z(b,function(){0===moment(new Date(b)).hour()&&0===moment(new Date(b)).minute()&&(a.settings.filter.endDate=moment(new Date(b)).endOf("day").format("YYYY-MM-DD HH:mm:ss:SSSS")),a.applyFiltersToUrl()})},a.applyFiltersToUrl=function(){var b=JSON.stringify(angular.copy(c.search()));c.search({}),a.settings.filter.limit&&c.search("limit",a.settings.filter.limit),a.settings.filter.startDate&&c.search("startDate",a.settings.filter.startDate),a.settings.filter.endDate&&c.search("endDate",a.settings.filter.endDate),a.settings.filter.transaction.status&&c.search("txStatus",a.settings.filter.transaction.status),a.settings.filter.transaction.channel&&c.search("txChannel",a.settings.filter.transaction.channel),a.settings.filter.transaction.statusCode&&c.search("txStatusCode",a.settings.filter.transaction.statusCode),a.settings.filter.transaction.host&&c.search("txHost",a.settings.filter.transaction.host),a.settings.filter.transaction.port&&c.search("txPort",a.settings.filter.transaction.port),a.settings.filter.transaction.path&&c.search("txPath",a.settings.filter.transaction.path),a.settings.filter.transaction.requestParamKey&&c.search("txParamKey",a.settings.filter.transaction.requestParamKey),a.settings.filter.transaction.requestParamValue&&c.search("txParamValue",a.settings.filter.transaction.requestParamValue),a.settings.filter.transaction.client&&c.search("txClient",a.settings.filter.transaction.client),a.settings.filter.transaction.wasRerun&&c.search("txWasRerun",a.settings.filter.transaction.wasRerun),a.settings.filter.transaction.propertyKey&&c.search("txPropertyKey",a.settings.filter.transaction.propertyKey),a.settings.filter.transaction.propertyValue&&c.search("txPropertyValue",a.settings.filter.transaction.propertyValue),a.settings.filter.transaction.method&&c.search("txHttpMethod",a.settings.filter.transaction.method),a.settings.filter.route.statusCode&&c.search("routeStatusCode",a.settings.filter.route.statusCode),a.settings.filter.route.host&&c.search("routeHost",a.settings.filter.route.host),a.settings.filter.route.port&&c.search("routePort",a.settings.filter.route.port),a.settings.filter.route.path&&c.search("routePath",a.settings.filter.route.path),a.settings.filter.route.requestParamKey&&c.search("routeParamKey",a.settings.filter.route.requestParamKey),a.settings.filter.route.requestParamValue&&c.search("routeParamValue",a.settings.filter.route.requestParamValue),a.settings.filter.orchestration.statusCode&&c.search("orchStatusCode",a.settings.filter.orchestration.statusCode),a.settings.filter.orchestration.host&&c.search("orchHost",a.settings.filter.orchestration.host),a.settings.filter.orchestration.port&&c.search("orchPort",a.settings.filter.orchestration.port),a.settings.filter.orchestration.path&&c.search("orchPath",a.settings.filter.orchestration.path),a.settings.filter.orchestration.requestParamKey&&c.search("orchParamKey",a.settings.filter.orchestration.requestParamKey),a.settings.filter.orchestration.requestParamValue&&c.search("orchParamValue",a.settings.filter.orchestration.requestParamValue);var d=JSON.stringify(angular.copy(c.search()));b===d&&a.refreshTransactionsList()};var A=function(){var b=localStorage.getItem("consoleSession");b=JSON.parse(b),b.sessionUserSettings=a.settings,localStorage.setItem("consoleSession",JSON.stringify(b))};a.refreshTransactionsList=function(){if(g.AlertReset(),a.validateFormFilters(),n=moment()-q,a.ngError.hasErrors===!1){if(a.dateApplied=a.settings.filter.startDate||a.settings.filter.endDate?!0:!1,a.transactions=null,a.showpage=0,a.bulkRerun){var b=a.returnFilters();b.filterRepresentation="bulkrerun",b.filterLimit=a.defaultBulkRerunLimit,delete b.filterPage,a.bulkRerunActive=!0,f.Transactions.query(b,x,y)}else f.Transactions.query(a.returnFilters(),x,y);A()}else g.AlertAddMsg("server","danger","You appear to have errors in your filter query. Please correct and try again")},a.refreshTransactionsList();var B=function(b){a.transactions=a.transactions.concat(b),b.length<a.settings.filter.limit&&(a.loadMoreBtn=!1,g.AlertAddMsg("bottom","warning","There are no more transactions to retrieve")),a.toggleCheckedAll(),a.busyLoadingMore=!1},C=function(b){a.loadMoreBtn=!1,g.AlertAddServerMsg(b.status)};a.loadMoreTransactions=function(){a.busyLoadingMore=!0,g.AlertReset(),a.showpage++;var b=a.returnFilters();b.filters["request.timestamp"]||(b.filters["request.timestamp"]=JSON.stringify({$lte:moment(h-q).format()})),f.Transactions.query(b,B,C)},a.viewTransactionDetails=function(b,d){if("TD"===d.target.tagName){var e=c.absUrl(),f=c.url(),g=e.replace(f,""),h=g+"/"+b;a.settings.list.tabview&&"new"===a.settings.list.tabview?window.open(h,"_blank"):(c.path(b),c.search({}))}},a.filtersApplied=function(){return a.dateApplied?!0:a.settings.filter.limit!==i?!0:a.settings.filter.transaction.wasRerun!==j?!0:Object.keys(a.settings.filter.transaction).length>1?!0:s(a.settings.filter.orchestration)&&s(a.settings.filter.route)?!1:!0},a.clearFilters=function(){g.AlertReset(),a.bulkRerunActive=!1,a.bulkRerun=!1,a.settings.filter.limit=i,a.settings.filter.startDate="",a.settings.filter.endDate="",a.settings.filter.transaction={},a.settings.filter.orchestration={},a.settings.filter.route={},a.settings.filter.transaction.wasRerun=j,a.settings.list.tabview=k,a.settings.list.autoupdate=l,c.search({}),a.advancedFilters.isCollapsed=!0,a.refreshTransactionsList()},a.applyDefaultFilters=function(){g.AlertReset(),a.bulkRerunActive=!1,a.bulkRerun=!1;var b=function(b){t(b.settings.filter),a.refreshTransactionsList()},c=function(a){g.AlertAddMsg("top","danger","An error has occurred while fetching the users' filters: #"+a.status+" - "+a.data)};f.Users.get({email:p},b,c)},a.persistUserFiltersToDatabase=function(){g.AlertReset();var b=function(){g.AlertAddMsg("top","success","User filters have been saved successfully")},c=function(a){g.AlertAddMsg("top","danger","An error has occurred while saving the users' filters: #"+a.status+" - "+a.data)},d=function(a){var d=angular.copy(a);a.$update(function(){b(d)},c)},e=f.Users.get({email:p},function(){e.settings||(e.settings={}),e.settings.filter||(e.settings.filter={}),e.settings.filter=a.settings.filter,d(e)})},a.bulkRerunInitiate=function(){a.bulkRerun=!0,a.refreshTransactionsList()},a.bulkRerunCancel=function(){a.bulkRerun=!1,a.bulkRerunActive=!1,a.refreshTransactionsList()},a.bulkRerunContinue=function(){a.bulkRerun=!1,a.checkbox.checkAll=!0,a.toggleCheckedAll(),a.confirmRerunTransactions()},a.confirmRerunTransactions=function(){g.AlertReset();var c=a.transactionsSelected,d=a.rerunTransactionsSelected;b.open({templateUrl:"views/transactionsRerunModal.html",controller:"TransactionsRerunModalCtrl",scope:a,resolve:{transactionsSelected:function(){return c},rerunTransactionsSelected:function(){return d}}})},a.toggleCheckedAll=function(){a.checkbox.checkAll===!0?(a.transactionsSelected=[],a.rerunTransactionsSelected=0,angular.forEach(a.transactions,function(b){b.canRerun&&a.channelsMap[b.channelID].rerun&&(a.transactionsSelected.push(b._id),b.childIDs&&b.childIDs.length>0&&a.rerunTransactionsSelected++)})):(a.transactionsSelected=[],a.rerunTransactionsSelected=0)};var D=function(a,b){var c=b.filter(function(b){return b._id===a?b:void 0})[0];return c};a.toggleTransactionSelection=function(b){var c=a.transactionsSelected.indexOf(b),d=D(b,a.transactions);c>-1?(a.transactionsSelected.splice(c,1),d.childIDs&&d.childIDs.length>0&&a.rerunTransactionsSelected--):(a.transactionsSelected.push(b),d.childIDs&&d.childIDs.length>0&&a.rerunTransactionsSelected++);

},a.resetCheckedItems=function(){a.transactionsSelected=[],a.rerunTransactionsSelected=0,a.checkbox.checkAll=!1},a.$on("transactionRerunSuccess",function(){a.bulkRerunActive=!1,a.bulkRerun=!1,a.refreshTransactionsList()});var E;a.pollForLatest=function(){var b=a.returnFilters();b.filters["request.timestamp"]||(b.filters["request.timestamp"]=JSON.stringify({$gte:moment(n).format()}),n=moment()-q,delete b.filterPage,delete b.filterLimit,f.Transactions.query(b,function(b){b.forEach(function(b){a.transactions.unshift(b),a.baseIndex--})}))},a.pollForProcessingUpdates=function(){a.transactions.forEach(function(b){"Processing"===b.status&&f.Transactions.get({transactionId:b._id,filterRepresentation:"simple"},function(b){a.transactions.forEach(function(a){a._id===b._id&&(a.status=b.status)})})})},a.startPolling=function(){E||(E=e(function(){a.pollForLatest(),a.pollForProcessingUpdates()},r))},a.stopPolling=function(){angular.isDefined(E)&&(e.cancel(E),E=void 0)},f.Heartbeat.get(function(b){q=moment()-moment(b.now),n=moment()-q,a.settings.list.autoupdate&&a.startPolling()}),a.$on("$destroy",a.stopPolling)}]),angular.module("openhimConsoleApp").controller("TransactionDetailsCtrl",["$scope","$modal","$location","$routeParams","Api","Alerting",function(a,b,c,d,e,f){var g=JSON.parse(sessionStorage.getItem("currTxList"));if(a.pagingEnabled=!0,g?-1===g.indexOf(d.transactionId)&&(a.pagingEnabled=!1):a.pagingEnabled=!1,a.next=null,a.prev=null,a.pagingEnabled){var h=g.indexOf(d.transactionId);a.txNumber=h+1,a.txTotal=g.length,a.currFilterURL=sessionStorage.getItem("currFilterURL"),0!==h&&(a.prev=g[h-1]),h!==g.length-1&&(a.next=g[h+1])}var i=function(b){if(a.transactionDetails=b,b.request&&b.request.body&&b.request.headers&&returnContentType(b.request.headers)){var c=beautifyIndent(returnContentType(b.request.headers),b.request.body);a.transactionDetails.request.body=c.content}if(b.response&&b.response.body&&b.response.headers&&returnContentType(b.response.headers)){var d=beautifyIndent(returnContentType(b.response.headers),b.response.body);a.transactionDetails.response.body=d.content}if(b.request&&b.request.timestamp&&b.response&&b.response.timestamp){var f=moment(b.response.timestamp)-moment(b.request.timestamp);if(f>=1e3){var g=function(a,b){return+(Math.round(a+"e+"+b)+"e-"+b)};b.transactionTime=g(f/1e3,3)+" s"}else b.transactionTime=f+" ms"}var h=localStorage.getItem("consoleSession");h=JSON.parse(h),a.consoleSession=h,e.Users.get({email:a.consoleSession.sessionUser},function(c){e.Channels.get({channelId:b.channelID},function(b){a.channel=b,a.routeDefs={},b.routes.forEach(function(b){a.routeDefs[b.name]=b}),("undefined"==typeof b.status||"enabled"===b.status)&&(c.groups.indexOf("admin")>=0?a.rerunAllowed=!0:angular.forEach(c.groups,function(c){b.txRerunAcl.indexOf(c)>=0&&(a.rerunAllowed=!0)}))},function(){})},function(){}),b.clientID&&(a.client=e.Clients.get({clientId:b.clientID,property:"clientName"}))},j=function(a){f.AlertAddServerMsg(a.status)};e.Transactions.get({transactionId:d.transactionId,filterRepresentation:"fulltruncate"},i,j),a.returnFilterObject=function(){var a={};return a.filterPage=0,a.filterLimit=0,a.filters={},a.filters.parentID=d.transactionId,a},a.fetchChildTransactions=function(){e.Transactions.query(a.returnFilterObject(),function(b){a.childTransactions=b},function(a){f.AlertAddServerMsg(a.status)})},a.fetchChildTransactions(),a.viewTransactionDetails=function(a){c.path(a)},a.confirmRerunTransactions=function(){var c=[a.transactionDetails._id],d=0;a.transactionDetails.childIDs&&a.transactionDetails.childIDs.length>0&&(d=1),b.open({templateUrl:"views/transactionsRerunModal.html",controller:"TransactionsRerunModalCtrl",resolve:{transactionsSelected:function(){return c},rerunTransactionsSelected:function(){return d}}})},a.viewAddReqResDetails=function(c,d,e,f){b.open({templateUrl:"views/transactionsAddReqResModal.html",controller:"TransactionsAddReqResModalCtrl",windowClass:"modal-fullview",resolve:{record:function(){return c},channel:function(){return d},transactionId:function(){return a.transactionDetails._id},recordType:function(){return e},index:function(){return f}}})},a.viewBodyDetails=function(a,c,d){b.open({templateUrl:"views/transactionsBodyModal.html",controller:"TransactionsBodyModalCtrl",windowClass:"modal-fullview",resolve:{bodyData:function(){return{type:a,content:c,headers:d}}}})}}]),angular.module("openhimConsoleApp").controller("TransactionsRerunModalCtrl",["$scope","$modalInstance","Api","Notify","Alerting","transactionsSelected","rerunTransactionsSelected",function(a,b,c,d,e,f,g){a.rerunSuccess=!1,a.transactionsSelected=f,a.rerunTransactionsSelected=g,a.taskSetup={},a.taskSetup.batchSize=1,a.taskSetup.paused=!1,1===g&&1===f.length?e.AlertAddMsg("rerun","warning","This transaction has already been rerun"):g>0&&e.AlertAddMsg("rerun","warning",g+" of these transactions have already been rerun");var h=function(){d.notify("TasksChanged"),a.rerunSuccess=!0,a.$emit("transactionRerunSuccess")};a.confirmRerun=function(){var b=a.transactionsSelected;a.task=new c.Tasks({tids:b,batchSize:a.taskSetup.batchSize,paused:a.taskSetup.paused}),a.task.$save({},h)},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("openhimConsoleApp").controller("TransactionsAddReqResModalCtrl",["$scope","$modal","$modalInstance","record","channel","transactionId","recordType","index",function(a,b,c,d,e,f,g,h){if(a.record=d,a.channel=e,a.viewFullBody=!1,a.viewFullBodyType=null,a.viewFullBodyContent=null,a.fullBodyTransformLang=null,a.transactionId=f,a.recordPathRequest=g+"["+h+"].request",a.recordPathResponse=g+"["+h+"].response",d.request&&d.request.body&&d.request.headers&&returnContentType(d.request.headers)){var i=beautifyIndent(returnContentType(d.request.headers),d.request.body);a.record.request.body=i.content,a.requestTransformLang=i.lang}if(d.response&&d.response.body&&d.response.headers&&returnContentType(d.response.headers)){var j=beautifyIndent(returnContentType(d.response.headers),d.response.body);a.record.response.body=j.content,a.responseTransformLang=j.lang}a.toggleFullView=function(b,c,d){b&&c?(a.viewFullBody=!0,a.viewFullBodyType=b,a.viewFullBodyContent=c,a.fullBodyTransformLang=d):a.viewFullBody=!1},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("openhimConsoleApp").controller("TransactionsBodyModalCtrl",["$scope","$modalInstance","bodyData",function(a,b,c){if(a.bodyData=c,a.bodyData.content&&c.headers&&returnContentType(c.headers)){var d=beautifyIndent(returnContentType(c.headers),c.content);a.bodyData.content=d.content}a.cancel=function(){b.dismiss("cancel")}}]),angular.module("openhimConsoleApp").controller("TasksCtrl",["$scope","$modal","$location","$interval","Api","Alerting","$route",function(a,b,c,d,e,f,g){function h(a,b){var c=new e.Tasks;c._id=a._id,c.status=b,c.$update({},function(){g.reload()})}var i=moment();a.showpage=0,a.showlimit=10,a.filters={},a.filters.limit=10,a.settings={},a.settings.list={},a.settings.list.tabview="same",a.settings.list.autoupdate=!0;var j,k=0;a.baseIndex=0;var l=5e3;c.search().limit&&(a.filters.limit=c.search().limit),c.search().date&&(a.filters.date=c.search().date),c.search().status&&(a.filters.status=c.search().status),c.search().user&&(a.filters.user=c.search().user),a.users=e.Users.query(),a.refreshSuccess=function(b){a.tasks=b,b.length<a.showlimit?(jQuery("#loadMoreBtn").hide(),0===b.length&&f.AlertAddMsg("bottom","warning","There are no tasks for the current filters")):jQuery("#loadMoreBtn").show()},a.refreshError=function(a){jQuery("#loadMoreBtn").hide(),f.AlertAddServerMsg(a.status)},a.returnFilters=function(){var b,c={};if(c.filterPage=a.showpage,c.filterLimit=a.showlimit,c.filters={},b=a.filters.date){var d=moment(b).format(),e=moment(b).endOf("day").format();c.filters.created=JSON.stringify({$gte:d,$lte:e})}var f=a.filters.status;valueNotEmpty(f)===!0&&(c.filters.status=f);var g=a.filters.user;return valueNotEmpty(g)===!0&&(c.filters.user=g),c};var m=function(){for(var a in c.search())c.search().hasOwnProperty(a)&&c.search(a,null)};a.applyFilterIfValidDate=function(b){moment(b,"YYYY-MM-DD",!0).isValid()&&a.applyFiltersToUrl()},a.applyFiltersToUrl=function(){var b=JSON.stringify(angular.copy(c.search()));m(),a.filters.status&&c.search("status",a.filters.status),a.filters.user&&c.search("user",a.filters.user),a.filters.limit&&c.search("limit",a.filters.limit),a.filters.date&&c.search("date",a.filters.date);var d=JSON.stringify(angular.copy(c.search()));b===d&&a.refreshTasksList()},a.refreshTasksList=function(){f.AlertReset(),a.tasks=null,a.showpage=0,a.showlimit=a.filters.limit,e.Tasks.query(a.returnFilters(),a.refreshSuccess,a.refreshError)},a.refreshTasksList();var n=function(b){a.tasks=a.tasks.concat(b),a.tasks=jQuery.unique(a.tasks),b.length<a.showlimit&&(jQuery("#loadMoreBtn").hide(),f.AlertAddMsg("bottom","warning","There are no more tasks to retrieve")),a.busyLoadingMore=!1},o=function(a){jQuery("#loadMoreBtn").hide(),f.AlertAddServerMsg(a.status)};a.loadMoreTasks=function(){a.busyLoadingMore=!0,f.AlertReset(),a.showpage++;var b=a.returnFilters();b.filters.created||(b.filters.created=JSON.stringify({$lte:moment(i-k).format()})),e.Tasks.query(a.returnFilters(),n,o)},a.clearFilters=function(){a.filters.limit=100,a.filters.date="",a.filters.status="",a.filters.user="",a.settings.list.tabview="same";var b=JSON.stringify(angular.copy(c.search()));m();var d=JSON.stringify(angular.copy(c.search()));b===d&&a.refreshTasksList()},a.viewTaskDetails=function(b){var d=c.protocol()+"://"+c.host()+":"+c.port()+"/#/",e=d+b;a.settings.list.tabview&&"new"===a.settings.list.tabview?window.open(e,"_blank"):c.path(b)},a.getProcessedTotal=function(a){var b=a.totalTransactions,c=a.remainingTransactions;return parseInt(b-c)},a.getProcessedPercentage=function(a){var b=a.totalTransactions,c=a.remainingTransactions,d=b-c;return(100/b*d).toFixed(0)+"%"},a.getExecutionTime=function(a){if(a){if(a.completedDate){var b=new Date(a.created),c=new Date(a.completedDate),d=c-b,e=d/1e3;return e.toFixed(2)}return 0}},a.pauseTask=function(a){h(a,"Paused")},a.resumeTask=function(a){h(a,"Queued")},a.cancelTask=function(a){var c={title:"Cancel Task",button:"Yes",message:"Are you sure you want to cancel this task?"},d=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});d.result.then(function(){h(a,"Cancelled")},function(){})};var p;a.pollForLatest=function(){var b=a.returnFilters();b.filters.created||(b.filters.created=JSON.stringify({$gte:moment(j).format()}),j=moment()-k,delete b.filterPage,delete b.filterLimit,e.Tasks.query(b,function(b){b.forEach(function(b){a.tasks.unshift(b),a.baseIndex--})}))},a.pollForProcessingUpdates=function(){a.tasks.forEach(function(b){if("Processing"===b.status||"Queued"===b.status){var c={};c.taskId=b._id,c.filterPage=0,c.filterLimit=0,c.filters={},e.Tasks.get(c,function(b){a.tasks.forEach(function(a){a._id===b._id&&(a.status=b.status,a.remainingTransactions=b.remainingTransactions,a.completedDate=b.completedDate)})})}})},a.startPolling=function(){p||(p=d(function(){a.pollForLatest(),a.pollForProcessingUpdates()},l))},a.stopPolling=function(){angular.isDefined(p)&&(d.cancel(p),p=void 0)},e.Heartbeat.get(function(b){k=moment()-moment(b.now),j=moment()-k,a.settings.list.autoupdate&&a.startPolling()}),a.$on("$destroy",a.stopPolling)}]),angular.module("openhimConsoleApp").controller("TaskDetailsCtrl",["$scope","$modal","$location","$routeParams","Api","Alerting","$route",function(a,b,c,d,e,f,g){function h(a,b){var c=new e.Tasks;c._id=a._id,c.status=b,c.$update({},function(){g.reload()})}a.showpage=1,a.showlimit=100,a.filters={},a.filters.limit=100,a.settings={},a.settings.list={},a.settings.list.tabview="same",c.search().limit&&(a.filters.limit=c.search().limit),c.search().tstatus&&(a.filters.tstatus=c.search().tstatus),c.search().rerunStatus&&(a.filters.rerunStatus=c.search().rerunStatus),c.search().hasErrors&&(a.filters.hasErrors=c.search().hasErrors),c.search().page&&(a.showpage=parseInt(c.search().page)),a.setPagination=function(a){c.search("page",a)};var i=function(b){a.task=b,a.totalFilteredTransactions=b.totalFilteredTransactions;var d=a.showlimit,e=a.showpage,f=Math.ceil(b.totalFilteredTransactions/d);if("100%"!==a.getProcessedPercentage(b)&&b.totalFilteredTransactions>d&&!c.search().page&&b.totalTransactions===b.totalFilteredTransactions){var g=a.getProcessedTotal(b);a.setPagination(Math.ceil(g/d))}a.pageIndexBase=(e-1)*d,a.pagesArray=[];for(var h=1;f>=h;h++){var i="";e===h&&(i="active"),a.pagesArray.push({pageNum:h,status:i})}},j=function(a){f.AlertAddServerMsg(a.status)};a.returnFilters=function(){var b={};b.taskId=d.taskId,b.filterPage=a.showpage-1,b.filterLimit=a.showlimit,b.filters={};var c=a.filters.tstatus;valueNotEmpty(c)===!0&&(b.filters.tstatus=c);var e=a.filters.rerunStatus;valueNotEmpty(e)===!0&&(b.filters.rerunStatus=e);var f=a.filters.hasErrors;return valueNotEmpty(f)===!0&&(b.filters.hasErrors=f),b};var k=function(){for(var a in c.search())c.search().hasOwnProperty(a)&&c.search(a,null)};a.applyFiltersToUrl=function(){var b=JSON.stringify(angular.copy(c.search()));k(),a.filters.limit&&c.search("limit",a.filters.limit),a.filters.tstatus&&c.search("tstatus",a.filters.tstatus),a.filters.rerunStatus&&c.search("rerunStatus",a.filters.rerunStatus),a.filters.hasErrors&&c.search("hasErrors",a.filters.hasErrors);var d=JSON.stringify(angular.copy(c.search()));b===d&&a.refreshTaskDetails()},a.refreshTaskDetails=function(){f.AlertReset(),a.task=null,a.showlimit=a.filters.limit,e.Tasks.get(a.returnFilters(),i,j)},a.refreshTaskDetails(),a.clearFilters=function(){a.filters.limit=100,a.filters.tstatus="",a.filters.rerunStatus="",a.filters.hasErrors="",a.settings.list.tabview="same";var b=JSON.stringify(angular.copy(c.search()));k();var d=JSON.stringify(angular.copy(c.search()));b===d&&a.refreshTaskDetails()},a.getProcessedTotal=function(a){if(a){var b=a.totalTransactions,c=a.remainingTransactions;return parseInt(b-c)}},a.getProcessedPercentage=function(a){if(a){var b=a.totalTransactions,c=a.remainingTransactions,d=b-c;return(100/b*d).toFixed(0)+"%"}},a.getExecutionTime=function(a){if(a){if(a.completedDate){var b=new Date(a.created),c=new Date(a.completedDate),d=c-b,e=d/1e3;return e.toFixed(2)}return 0}},a.viewTransactionDetails=function(b){var d=c.protocol()+"://"+c.host()+":"+c.port()+"/#/",e=d+b;a.settings.list.tabview&&"new"===a.settings.list.tabview?window.open(e,"_blank"):c.path(b)},a.pauseTask=function(a){h(a,"Paused")},a.resumeTask=function(a){h(a,"Queued")},a.cancelTask=function(a){var c={title:"Cancel Task",button:"Yes",message:"Are you sure you want to cancel this task?"},d=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});d.result.then(function(){h(a,"Cancelled")},function(){})}}]),angular.module("openhimConsoleApp").controller("ContactGroupsCtrl",["$scope","$modal","Api","Alerting",function(a,b,c,d){var e=function(b){a.contactGroups=b,0===b.length&&d.AlertAddMsg("bottom","warning","There are currently no contact lists created")},f=function(a){d.AlertAddServerMsg(a.status)};c.ContactGroups.query(e,f),a.$on("contactGroupChanged",function(){c.ContactGroups.query(e,f)}),a.addContactGroup=function(){d.AlertReset(),b.open({templateUrl:"views/contactGroupsModal.html",controller:"ContactGroupsModalCtrl",resolve:{contactGroup:function(){}}})},a.editContactGroup=function(a){d.AlertReset(),b.open({templateUrl:"views/contactGroupsModal.html",controller:"ContactGroupsModalCtrl",resolve:{contactGroup:function(){return a}}})};var g=function(){a.contactGroups=c.ContactGroups.query(),d.AlertAddMsg("top","success","The contact list has been deleted successfully")},h=function(a){if(409===a.status){for(var b="Could not delete the contact list because it is associated with the following channels: ",c=0;c<a.data.length;c++)c>0&&(b+=", "),b+=a.data[c].name;d.AlertAddMsg("top","warning",b)}else d.AlertAddMsg("top","danger","An error has occurred while deleting the contact list: #"+a.status+" - "+a.data)};a.confirmDelete=function(a){d.AlertReset();var c={title:"Delete Contact Group",button:"Delete",message:'Are you sure you wish to delete the Contact list "'+a.group+'"?'},e=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});e.result.then(function(){a.$remove(g,h)},function(){})}}]),angular.module("openhimConsoleApp").controller("ContactGroupsModalCtrl",["$scope","$modalInstance","$timeout","Api","login","Notify","Alerting","contactGroup",function(a,b,c,d,e,f,g,h){a.temp={},a.alertUsers=d.Users.query(function(){a.usersMap={},angular.forEach(a.alertUsers,function(b){a.usersMap[b.email]=b.firstname+" "+b.surname+" ("+b.email+")"})},function(){}),h?(a.update=!0,a.contactGroup=d.ContactGroups.get({groupId:h._id})):(a.update=!1,a.contactGroup=new d.ContactGroups);var i=function(){f.notify("contactGroupChanged"),b.close()},j=function(){g.AlertAddMsg("top","success","The contact list has been saved successfully"),i()},k=function(a){g.AlertAddMsg("top","danger","An error has occurred while saving the contact lists' details: #"+a.status+" - "+a.data),i()},l=function(b){a.update?b.$update(j,k):b.$save({},j,k)};a.cancel=function(){b.dismiss("cancel")},a.newGroupUserBackup=null,a.newGroupUser={},a.addGroupUser=function(b){a.contactGroup.users||(a.contactGroup.users=[]),a.contactGroup.users.push(angular.copy(b)),a.newGroupUserBackup=null,a.newGroupUser.user="",a.newGroupUser.method="",a.newGroupUser.maxAlerts=""},a.editGroupUser=function(b,c){a.contactGroup.users.splice(b,1),null!==a.newGroupUserBackup&&a.contactGroup.users.push(angular.copy(a.newGroupUserBackup)),a.newGroupUserBackup=angular.copy(c),a.newGroupUser=c},a.removeGroupUser=function(b){a.contactGroup.users.splice(b,1)},a.isGroupUserValid=function(){return a.newGroupUser.user&&a.newGroupUser.method&&a.newGroupUser.maxAlerts?!0:!1},a.validateFormContactGroups=function(){g.AlertReset("hasErrors"),c.cancel(a.clearValidation),a.ngError={},a.ngError.hasErrors=!1,a.contactGroup.group||(a.ngError.group=!0,a.ngError.hasErrors=!0),a.contactGroup.users&&0!==a.contactGroup.users.length||(a.ngError.users=!0,a.ngError.hasErrors=!0),a.ngError.hasErrors&&(a.clearValidation=c(function(){a.ngError={}},5e3),g.AlertAddMsg("hasErrors","danger",a.validationFormErrorsMsg))},a.submitFormContactGroups=function(){a.validateFormContactGroups(),a.ngError.hasErrors===!1&&l(a.contactGroup)}}]),angular.module("openhimConsoleApp").controller("LoginCtrl",["$scope","login","$window","$location","$timeout","$rootScope","Alerting","Api","config",function(a,b,c,d,e,f,g,h,i){a.config=i,a.emailFocus=!0,a.passwordFocus=!1,a.rootPasswordReset=!1,a.resetSuccess=!1,"#/logout"===c.location.hash&&(localStorage.removeItem("consoleSession"),f.sessionUser=null,f.navMenuVisible=!1),a.loginEmail="",a.loginPassword="",a.linkUserEmail="",a.$watch("loginEmail",function(b,c){(b||b!==c)&&(a.linkUserEmail="?email="+b)}),d.search().email&&(a.loginEmail=d.search().email,a.emailFocus=!1,a.passwordFocus=!0),a.validateLogin=function(){g.AlertReset();var b=a.loginEmail,c=a.loginPassword;b&&c?(g.AlertReset(),g.AlertAddMsg("login","warning","Busy checking your credentials..."),a.coreConnectionError=!1,a.checkLoginCredentials(b,c)):g.AlertAddMsg("login","danger","Please provide your login credentials")},a.checkLoginCredentials=function(d,e){b.login(d,e,function(b){g.AlertReset(),"Authentication Success"===b?"root@openhim.org"===d&&"openhim-password"===e?a.rootPasswordReset=!0:(a.createUserSession(d),c.location=f.referringURL?"#"+f.referringURL:"#/transactions"):"Internal Server Error"===b?a.coreConnectionError=!0:g.AlertAddMsg("login","danger","The supplied credentials were incorrect. Please try again")})},a.resetRootPassword=function(){if(g.AlertReset(),!a.password||!a.passwordConfirm)return void g.AlertAddMsg("login","danger","Please provide both password fields");if(a.password!==a.passwordConfirm)return void g.AlertAddMsg("login","danger","The supplied passwords do not match");if("openhim-password"===a.password)return void g.AlertAddMsg("login","danger","The supplied password is the same as the current one");var d=angular.copy(a.password);h.Users.get({email:"root@openhim.org"},function(f){var h=getHashAndSalt(d);f.passwordAlgorithm=h.algorithm,"undefined"!=typeof h.salt&&null!==h.salt&&(f.passwordSalt=h.salt),f.passwordHash=h.hash,f.$update({},function(){b.login("root@openhim.org",d,function(b){b?(a.createUserSession("root@openhim.org"),a.password="",a.passwordConfirm="",a.resetSuccess=!0,g.AlertAddMsg("login","success","Root Password Successfully Reset."),g.AlertAddMsg("login","success","You will be redirected to the 'Transactions' page shortly."),e(function(){c.location="#/transactions"},5e3)):g.AlertAddServerMsg()})},function(){g.AlertAddServerMsg()})},function(){g.AlertAddServerMsg()})},a.createUserSession=function(a){if(!a)return"No Email supplied!";var c=b.getLoggedInUser();if(!c.groups)return"Logged in user could not be found!";var d=new Date,e=new Date(d.getTime()+72e5),f=Math.random().toString(36).slice(2).toUpperCase(),g=c.groups,h=c.settings,i={sessionID:f,sessionUser:a,sessionUserGroups:g,sessionUserSettings:h,expires:e};localStorage.setItem("consoleSession",JSON.stringify(i))}}]),angular.module("openhimConsoleApp").controller("ProfileCtrl",["$http","$scope","$timeout","Api","login","Alerting",function(a,b,c,d,e,f){var g=localStorage.getItem("consoleSession");g=JSON.parse(g),b.consoleSession=g,b.taglistUserRoleOptions=[],b.temp={},d.Channels.query(function(a){b.channels=a,b.primaryRoutes=[],b.secondaryRoutes=[],angular.forEach(a,function(a){angular.forEach(a.routes,function(a){a.primary?b.primaryRoutes.indexOf(a.name)<0&&b.primaryRoutes.push(a.name):b.secondaryRoutes.indexOf(a.name)<0&&b.secondaryRoutes.push(a.name)})})},function(){}),d.Mediators.query(function(a){b.mediators=a},function(){}),d.Users.query(function(a){angular.forEach(a,function(a){angular.forEach(a.groups,function(a){-1===b.taglistUserRoleOptions.indexOf(a)&&b.taglistUserRoleOptions.push(a)})})},function(){});var h=function(c){b.user=c,b.user.settings||(b.user.settings={}),b.user.settings.list||(b.user.settings.list={});var d=b.user.settings.visualizer&&b.user.settings.visualizer.endpoints&&!b.user.settings.visualizer.mediators;(!b.user.settings.visualizer||d)&&(d?(b.user.settings.visualizer.channels=[],b.user.settings.visualizer.mediators=[],b.user.settings.visualizer.time.minDisplayPeriod=100,angular.forEach(b.user.settings.visualizer.endpoints,function(a){b.user.settings.visualizer.channels.push({eventType:"channel",eventName:a.event.replace("channel-",""),display:a.desc})}),delete b.user.settings.visualizer.endpoints,angular.forEach(b.user.settings.visualizer.components,function(a){var b=a.event.split("-");b.length>1?(a.eventType=b[0],a.eventName=b[1]):(a.eventType="channel",a.eventName=a.event),a.display=a.desc,delete a.event,delete a.desc})):(b.user.settings.visualizer={},a.get("config/visualizer.json").success(function(a){angular.extend(b.user.settings.visualizer,angular.copy(a))})))},i=function(a){f.AlertAddServerMsg(a.status)};d.Users.get({email:b.consoleSession.sessionUser},h,i);var j=function(a){f.AlertReset(),f.AlertAddMsg("top","danger","An error has occurred while saving your details: #"+a.status+" - "+a.data)},k=function(a,c){b.consoleSession.sessionUserSettings=a.settings,localStorage.setItem("consoleSession",JSON.stringify(b.consoleSession)),""!==c?e.login(b.consoleSession.sessionUser,c,function(a){a?d.Users.get({email:b.consoleSession.sessionUser},h,i):j()}):d.Users.get({email:b.consoleSession.sessionUser},h,i),f.AlertReset(),f.AlertAddMsg("top","success","Your user details have been updated succesfully.")},l=function(a,c){var d=angular.copy(a);a.$update({},function(){k(d,c),b.goToTop()})},m=function(a,b,c,d){"undefined"!=typeof c&&null!==c&&(a.passwordSalt=c),a.passwordHash=b,l(a,d)};b.save=function(a,b){if(b){var c=getHashAndSalt(b);a.passwordAlgorithm=c.algorithm,m(a,c.hash,c.salt,b)}else l(a,"")},b.visualizer={},b.addSelectedChannel=function(){b.user.settings.visualizer.channels.push({eventType:"channel",eventName:b.visualizer.addSelectChannel.name,display:b.visualizer.addSelectChannel.name}),b.visualizer.addSelectChannel=null},b.addSelectedMediator=function(){b.user.settings.visualizer.mediators.push({mediator:b.visualizer.addSelectMediator.urn,name:b.visualizer.addSelectMediator.name,display:b.visualizer.addSelectMediator.name}),b.visualizer.addSelectMediator=null},b.addComponent=function(){b.visualizer.addComponent.eventType&&(b.user.settings.visualizer.components.push({eventType:b.visualizer.addComponent.eventType,eventName:b.visualizer.addComponent.eventName,display:b.visualizer.addComponent.display}),b.visualizer.addComponent.eventType="",b.visualizer.addComponent.eventName="",b.visualizer.addComponent.display="")},b.removeComponent=function(a){b.user.settings.visualizer.components.splice(a,1)},b.removeChannel=function(a){b.user.settings.visualizer.channels.splice(a,1)},b.removeMediator=function(a){b.user.settings.visualizer.mediators.splice(a,1)},b.validateFormProfile=function(){f.AlertReset("hasErrors"),f.AlertReset("top"),c.cancel(b.clearValidation),b.ngError={},b.ngError.hasErrors=!1,b.user.firstname||(b.ngError.firstname=!0,b.ngError.hasErrors=!0),b.user.surname||(b.ngError.surname=!0,b.ngError.hasErrors=!0),b.user.msisdn&&!isValidMSISDN(b.user.msisdn)&&(b.ngError.msisdn=!0,b.ngError.hasErrors=!0),b.userGroupAdmin&&0===b.user.groups.length&&(b.ngError.groups=!0,b.ngError.hasErrors=!0),b.temp.password&&(b.temp.passwordConfirm&&b.temp.password===b.temp.passwordConfirm||(b.ngError.passwordConfirm=!0,b.ngError.hasErrors=!0)),b.ngError.hasErrors&&(b.clearValidation=c(function(){b.ngError={}},5e3),f.AlertAddMsg("hasErrors","danger",b.validationFormErrorsMsg))},b.submitFormProfile=function(){b.validateFormProfile(),b.ngError.hasErrors===!1&&b.save(b.user,b.temp.password)}}]),angular.module("openhimConsoleApp").controller("MediatorsCtrl",["$scope","$modal","$location","Api","Alerting","MediatorDisplay",function(a,b,c,d,e,f){var g=function(b){a.mediators=b,0===b.length?e.AlertAddMsg("bottom","warning","There are currently no mediators created"):f.formatMediators(b)},h=function(a){e.AlertAddServerMsg(a.status)};d.Mediators.query(g,h),a.viewMediatorDetails=function(a,b){"TD"===b.target.tagName&&c.path(a)};var i=function(){a.mediators=d.Mediators.query(g,h),e.AlertAddMsg("top","success","The Mediator has been deleted successfully")},j=function(a){e.AlertAddMsg("top","danger","An error has occurred while deleting the Mediator: #"+a.status+" - "+a.data)};a.confirmDelete=function(a){e.AlertReset();var c={title:"Delete Mediator",button:"Delete",message:'Are you sure you wish to delete the mediator "'+a.name+'"?'},d=b.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});d.result.then(function(){a.$remove(i,j)},function(){})},a.editMediatorConfig=function(a){e.AlertReset(),b.open({templateUrl:"views/mediatorConfigModal.html",controller:"MediatorConfigModalCtrl",resolve:{mediator:function(){return a}}})}}]),angular.module("openhimConsoleApp").controller("MediatorDetailsCtrl",["$rootScope","$scope","$modal","$location","$routeParams","Api","Alerting","MediatorDisplay",function(a,b,c,d,e,f,g,h){var i=function(a){var b={};return a.config&&Object.keys(a.config).map(function(c){b[c]=a.configDefs.filter(function(a){return a.param===c})[0]}),b},j=function(a){h.formatMediator(a),b.mediatorDetails=a,b.mediatorDefsMap=i(a)},k=function(a){g.AlertAddServerMsg(a.status)};b.$on("mediatorConfigChanged",function(){f.Mediators.get({urn:e.urn},j,k)}),f.Mediators.get({urn:e.urn},j,k),b.editMediatorConfig=function(){g.AlertReset(),c.open({templateUrl:"views/mediatorConfigModal.html",controller:"MediatorConfigModalCtrl",resolve:{mediator:function(){return b.mediatorDetails}}})},b.addChannel=function(a){g.AlertReset("top"),f.MediatorChannels.save({urn:e.urn},[a],function(){g.AlertAddMsg("top","success","Successfully installed mediator channel")},function(){g.AlertAddMsg("top","danger","Oops, something went wrong. Could not install mediator channel.")})}}]),angular.module("openhimConsoleApp").controller("MediatorConfigModalCtrl",["$rootScope","$scope","$modalInstance","$timeout","Api","Notify","Alerting","mediator",function(a,b,c,d,e,f,g,h){b.mediator=e.Mediators.get({urn:h.urn},function(){b.mediator.config||(b.mediator.config={})});var i=function(){f.notify("mediatorConfigChanged"),c.close()},j=function(){g.AlertAddMsg("top","success","The mediator configuration was updated successfully"),i()},k=function(a){g.AlertAddMsg("top","danger","An error has occurred while saving the mediator config: #"+a.status+" - "+a.data),i()};b.saveConfig=function(){new e.MediatorConfig(b.mediator.config).$update({urn:b.mediator.urn},j,k)},b.cancel=function(){c.dismiss("cancel")}}]),angular.module("openhimConsoleApp").controller("SidebarCtrl",["$scope","$location",function(a,b){a.isCurrent=function(a){return a.length>1&&b.path().substr(0,a.length)===a?!0:b.path()===a?!0:!1}}]),angular.module("openhimConsoleApp").controller("ConfirmModalCtrl",["$scope","$modalInstance","confirmObject",function(a,b,c){a.confirmObject=c,a.confirmed=function(){b.close()},a.cancelled=function(){b.dismiss("cancel")}}]),angular.module("openhimConsoleApp").controller("VisualizerCtrl",["$scope","$http","$interval","$window","$modal","login","Api","Alerting","Fullscreen",function(a,b,c,d,e,f,g,h,i){function j(){r=localStorage.getItem("consoleSession"),r=JSON.parse(r),q=null,g.Users.get({email:r.sessionUser},function(b){q=b,g.Visualizers.query(function(b){a.visualizers=b,b.length>0&&(a.selectedVis=b[0],q.settings&&q.settings.selectedVisualizer&&b.forEach(function(b){b.name===q.settings.selectedVisualizer&&(a.selectedVis=b)}),u(a.selectedVis))},function(a){h.AlertAddServerMsg(a.status)})},function(a){h.AlertAddServerMsg(a.status)})}var k,l,m,n,o,p,q,r,s={};a.loadingVisualizer=!1,a.loadingVisualizerError=!1,a.loadingVisualizerErrorMsgs=[],a.isUsingOldVisualizerSettings=!1;var t=function(){g.Heartbeat.get(function(b){m=Date.now()-moment(b.now),a.play()})},u=function(b){a.loadingVisualizer=!0;var c,d,e,f,g,h,i,j,k,m=[],n=[],q=[];b.endpoints&&!b.mediators&&(a.isUsingOldVisualizerSettings=!0),angular.forEach(b.components,function(a){m.push(a)}),angular.forEach(b.channels,function(a){n.push(a)}),angular.forEach(b.mediators,function(a){q.push(a)}),(0===m.length||0===n.length)&&(a.loadingVisualizerError=!0,a.loadingVisualizer=!1,a.loadingVisualizerErrorMsgs.push({section:"Visualizations Management",msg:"Please ensure your visualizer has at least one Component and one Endpoint added!"})),c=b.size.responsive,d=parseInt(b.size.width),e=parseInt(b.size.height),p=parseInt(b.size.padding),d&&e&&p||(a.loadingVisualizerError=!0,a.loadingVisualizer=!1,a.loadingVisualizerErrorMsgs.push({section:"Size Management",msg:"Please ensure all size management fields are supplied!"})),f=b.color.inactive,g=b.color.active,h=b.color.error,i=b.color.text,(""===f||""===g||""===h||""===i)&&(a.loadingVisualizerError=!0,a.loadingVisualizer=!1,a.loadingVisualizerErrorMsgs.push({section:"Color Management",msg:"Please ensure all color management fields are supplied!"})),l=parseInt(b.time.updatePeriod),j=parseInt(b.time.minDisplayPeriod),a.visualizerSpeed=0,o=parseInt(b.time.maxSpeed),k=parseInt(b.time.maxTimeout),l&&o&&k||(a.loadingVisualizerError=!0,a.loadingVisualizer=!1,a.loadingVisualizerErrorMsgs.push({section:"Speed Management",msg:"Please ensure all speed management fields are supplied!"})),a.visualizerData=[],a.visualizerSettings={name:b.name,components:m,channels:n,mediators:q,visResponsive:c,visW:d,visH:e,pad:p,inactiveColor:f,activeColor:g,errorColor:h,textColor:i,updatePeriod:l,minDisplayPeriod:j,speed:a.visualizerSpeed,maxSpeed:o,maxTimeout:k},a.loadingVisualizer===!0&&(a.loadingVisualizer=!1,
t())};a.play=function(){a.showPlay=!1,a.showPause=!0,n=Date.now()-m,k=c(function(){g.Events.get({receivedTime:n},function(b){a.visualizerData=b.events,n=Date.now()-m})},l)};var v=function(){angular.isDefined(k)&&(c.cancel(k),k=void 0)};a.pause=function(){a.showPlay=!0,a.showPause=!1,v()},a.$on("$destroy",v),a.slowDown=function(){a.visualizerSpeed>-1*o+1&&a.visualizerSpeed--,a.speedText=a.setSpeedText()},a.speedUp=function(){a.visualizerSpeed<o-1&&a.visualizerSpeed++,a.speedText=a.setSpeedText()},a.setSpeedText=function(){return 0===a.visualizerSpeed?"":a.visualizerSpeed<0?-1*a.visualizerSpeed+1+"X Slower":a.visualizerSpeed>0?a.visualizerSpeed+1+"X Faster":void 0},a.addVisualiser=function(){h.AlertReset(),e.open({templateUrl:"views/visualizerModal.html",controller:"VisualizerModalCtrl",resolve:{visualizers:function(){return a.visualizers},visualizer:function(){return null},duplicate:function(){return null}}})},a.editVisualiser=function(b){h.AlertReset(),e.open({templateUrl:"views/visualizerModal.html",controller:"VisualizerModalCtrl",resolve:{visualizers:function(){return a.visualizers},visualizer:function(){return null},duplicate:function(){return b}}})},a.duplicateVisualiser=function(b){h.AlertReset(),e.open({templateUrl:"views/visualizerModal.html",controller:"VisualizerModalCtrl",resolve:{visualizers:function(){return a.visualizers},visualizer:function(){return b},duplicate:function(){return null}}})},a.isFullScreen=!1,a.goFullScreenViaWatcher=function(){a.isFullScreen=!a.isFullScreen},i.$on("FBFullscreen.change",function(b,c){c?(s.visResponsive=a.visualizerSettings.visResponsive,s.visW=a.visualizerSettings.visW,s.visH=a.visualizerSettings.visH,a.visualizerSettings.visResponsive&&(a.visualizerSettings.visResponsive=!1,a.visualizerSettings.visW=d.innerWidth-2*p,a.visualizerSettings.visH=d.innerHeight-8*p)):(a.visualizerSettings.visResponsive=s.visResponsive,a.visualizerSettings.visW=s.visW,a.visualizerSettings.visH=s.visH)}),j(),a.$on("visualizersChanged",function(){j()}),a.selectVis=function(b,c){c||(c=function(){}),a.selectedVis=b,r.sessionUserSettings||(r.sessionUserSettings={}),r.sessionUserSettings.selectedVisualizer=b.name,localStorage.setItem("consoleSession",JSON.stringify(r)),q.settings||(q.settings={}),q.settings.selectedVisualizer=b.name,u(b),g.Users.update(q,c)};var w=function(b,c){a.visualizers.splice(c,1),b===a.selectedVis&&(0===a.visualizers.length?a.selectedVis=null:a.selectVis(a.visualizers[0])),b.$remove(function(){h.AlertAddMsg("top","success","The visualizer has been deleted successfully")})};a.confirmRemoveVis=function(a,b){h.AlertReset();var c={title:"Delete Visualizer",button:"Delete",message:'Are you sure you wish to delete this visualizer "'+a.name+'"?'},d=e.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return c}}});d.result.then(function(){w(a,b)},function(){})}}]),angular.module("openhimConsoleApp").controller("VisualizerModalCtrl",["$http","$scope","$modalInstance","$timeout","Api","Notify","Alerting","visualizers","visualizer","duplicate",function(a,b,c,d,e,f,g,h,i,j){b.ngError={},b.validationRequiredMsg="This field is required.",i?(b.update=!0,b.visualizer=JSON.parse(angular.toJson(i))):j?(b.update=!1,j=JSON.parse(angular.toJson(j)),delete j._id,delete j.name,b.visualizer=j):(b.update=!1,b.visualizer={},a.get("config/visualizer.json").success(function(a){angular.extend(b.visualizer,angular.copy(a))})),b.cancel=function(){d.cancel(b.clearValidationRoute),c.dismiss("cancel")},e.Channels.query(function(a){b.channels=a,b.primaryRoutes=[],b.secondaryRoutes=[],angular.forEach(a,function(a){angular.forEach(a.routes,function(a){a.primary?b.primaryRoutes.indexOf(a.name)<0&&b.primaryRoutes.push(a.name):b.secondaryRoutes.indexOf(a.name)<0&&b.secondaryRoutes.push(a.name)})})},function(){}),e.Mediators.query(function(a){b.mediators=a},function(){}),b.viewModel={},b.addSelectedChannel=function(){b.visualizer.channels.push({eventType:"channel",eventName:b.viewModel.addSelectChannel.name,display:b.viewModel.addSelectChannel.name}),b.viewModel.addSelectChannel=null},b.addSelectedMediator=function(){b.visualizer.mediators.push({mediator:b.viewModel.addSelectMediator.urn,name:b.viewModel.addSelectMediator.name,display:b.viewModel.addSelectMediator.name}),b.viewModel.addSelectMediator=null},b.addComponent=function(){b.viewModel.addComponent.eventType&&(b.visualizer.components.push({eventType:b.viewModel.addComponent.eventType,eventName:b.viewModel.addComponent.eventName,display:b.viewModel.addComponent.display}),b.viewModel.addComponent.eventType="",b.viewModel.addComponent.eventName="",b.viewModel.addComponent.display="")},b.removeComponent=function(a){b.visualizer.components.splice(a,1)},b.removeChannel=function(a){b.visualizer.channels.splice(a,1)},b.removeMediator=function(a){b.visualizer.mediators.splice(a,1)},b.validateVisualizer=function(a,c){if(g.AlertReset("hasErrors"),d.cancel(b.clearValidation),b.ngError.hasErrors=!1,a.name){if(!b.update){var e=h.filter(function(b){return b.name===a.name});e.length>0&&(b.ngError.nameNotUnique=!0,b.ngError.hasErrors=!0)}}else b.ngError.hasNoName=!0,b.ngError.hasErrors=!0;(void 0===a.components||0===a.components.length)&&(b.ngError.hasErrors=!0,b.ngError.hasNoComponents=!0),(void 0===a.channels||0===a.channels.length)&&(b.ngError.hasErrors=!0,b.ngError.hasNoChannels=!0),b.ngError.hasErrors?(b.clearValidation=d(function(){b.ngError={},g.AlertReset("hasErrors")},5e3),g.AlertAddMsg("hasErrors","danger","There are errors on the form."),c("Error: Form has errors")):c()};var k=function(){f.notify("visualizersChanged"),c.close()},l=function(){g.AlertAddMsg("top","success","The visualizer has been saved successfully"),k()},m=function(){g.AlertAddMsg("top","danger","Failed to save the visualizer details because the visualizer name is not unique. Please try again."),k()};b.saveVisualizer=function(){b.validateVisualizer(b.visualizer,function(a){a||(b.update?e.Visualizers.update(b.visualizer,l,m):e.Visualizers.save({name:""},b.visualizer,l,m))})}}]),angular.module("openhimConsoleApp").controller("ForgotPasswordCtrl",["$scope","$location","Alerting","Api",function(a,b,c,d){a.userEmail="",a.showFormCtrl=!0,a.linkUserEmail="",a.$watch("userEmail",function(b,c){(b||b!==c)&&(a.linkUserEmail="?email="+b)}),b.search().email&&(a.userEmail=b.search().email),a.submitRequest=function(){c.AlertReset();var b=a.userEmail;b?"root@openhim.org"===b?c.AlertAddMsg("forgotPassword","danger",'Cannot reset password for "root@openhim.org"'):(c.AlertAddMsg("forgotPassword","warning","Busy checking your credentials..."),d.Authenticate.get({email:b},function(){d.UserPasswordResetRequest.get({email:b},function(){c.AlertReset(),c.AlertAddMsg("forgotPassword","info","Password reset email has been sent..."),a.showFormCtrl=!1},function(){c.AlertReset(),c.AlertAddMsg("forgotPassword","danger","An error occurred while trying to request a password reset. Please contact your system administrator")})},function(){c.AlertReset(),c.AlertAddMsg("forgotPassword","danger","Could not authenticate email address")})):c.AlertAddMsg("forgotPassword","danger","Please provide your email address")}}]),angular.module("openhimConsoleApp").controller("SetPasswordCtrl",["$scope","$modal","$routeParams","$timeout","$location","Api","Alerting",function(a,b,c,d,e,f,g){a.temp={},a.passwordSetSuccessful=!1;var h=function(b){a.user=b,a.tokenType=b.tokenType},i=function(a){g.AlertReset(),404===a.status?g.AlertAddMsg("top","danger","Invalid token"):410===a.status?g.AlertAddMsg("top","danger","The time to set the new user password has expired. Please contact your OpenHIM administrator to set your password"):g.AlertAddServerMsg(a.status)};f.UserPasswordToken.get({token:c.token},h,i);var j=function(){a.goToTop(),g.AlertReset(),g.AlertAddMsg("top","success","Your user details have been updated succesfully. You will be redirected to the login screen shortly."),a.passwordSetSuccessful=!0,a.redirectToLogin=d(function(){e.path("/login").search({email:a.user.email})},5e3)},k=function(a){g.AlertReset(),410===a.status?g.AlertAddMsg("top","danger","The time to set the new user password has expired. Please contact your OpenHIM administrator to set your password"):(g.AlertAddMsg("top","danger","An error has occurred while saving your details: #"+a.status+" - "+a.data),g.AlertAddMsg("top","danger","Please contact your OpenHIM administrator to set your password"))},l=function(a){f.UserPasswordToken.update({token:c.token},a,j,k)},m=function(a,b,c){"undefined"!=typeof c&&null!==c&&(a.passwordSalt=c),a.passwordHash=b,l(a)};a.save=function(a,b){if(b){var c=getHashAndSalt(b);a.passwordAlgorithm=c.algorithm,m(a,c.hash,c.salt,b)}},a.validateFormSetPassword=function(){g.AlertReset("hasErrors"),g.AlertReset("top"),d.cancel(a.clearValidation),a.ngError={},a.ngError.hasErrors=!1,a.user.firstname||(a.ngError.firstname=!0,a.ngError.hasErrors=!0),a.user.msisdn&&!isValidMSISDN(a.user.msisdn)&&(a.ngError.msisdn=!0,a.ngError.hasErrors=!0),a.user.surname||(a.ngError.surname=!0,a.ngError.hasErrors=!0),a.temp.password?a.temp.passwordConfirm&&a.temp.password===a.temp.passwordConfirm||(a.ngError.passwordConfirm=!0,a.ngError.hasErrors=!0):(a.ngError.password=!0,a.ngError.hasErrors=!0),a.ngError.hasErrors&&(a.clearValidation=d(function(){a.ngError={}},5e3),g.AlertAddMsg("hasErrors","danger",a.validationFormErrorsMsg))},a.submitFormSetPassword=function(){a.validateFormSetPassword(),a.ngError.hasErrors===!1&&a.save(a.user,a.temp.password)}}]),angular.module("openhimConsoleApp").controller("CertificatesCtrl",["$upload","$scope","$interval","$modal","Api","Alerting",function(a,b,c,d,e,f){b.serverRestarting=!1,b.restartTimeout=0,b.serverRestartRequired=!1,b.serverRestartError=!1,b.showImportResults=!1,b.certValidity={},b.resetCertificates=function(){e.Keystore.get({type:"cert"},function(a){b.currentServerCert=a,b.currentServerCert.watchFSForCert&&f.AlertAddMsg("watchFSForCert","warning","Generating of server certificates is disabled. Certificates are being managed from the file system, edit the OpenHIM config file to change this")},function(a){f.AlertAddServerMsg(a.status)}),b.trustedCertificates=e.Keystore.query({type:"ca"}),e.Keystore.query({type:"ca"},function(a){b.trustedCertificates=a},function(a){f.AlertAddServerMsg(a.status)}),e.Keystore.get({type:"validity"},function(a){b.certValidity=a},function(){b.certValidity.valid=!1})},b.resetCertificates(),b.uploadFail=function(a,c,d){"trustedCerts"===c?b.failedImports.push({filename:d,error:a.data,status:a.status}):f.AlertAddMsg(c,"danger","Upload error occured: [ File: "+d+" ] #"+a.status+" - "+a.data),b.importFail++},b.uploadSuccess=function(a,c){f.AlertAddMsg(a,"success","Newly Uploaded File: "+c),b.importSuccess++,b.serverRestartRequired=!0,b.resetCertificates(),b.goToTop()},b.createCertificateSuccess=function(){b.importSuccess++,b.serverRestartRequired=!0,b.resetCertificates(),b.goToTop()},b.$on("certificatesChanged",function(){b.createCertificateSuccess()}),b.uploadCertificate=function(a,c,d){f.AlertReset(),b.importFail=0,b.importSuccess=0,b.failedImports=[],b.importProgressStatus=0,b.importProgressType="";var g=0;switch(b.certificateObject=new e.Keystore,b.uploadType){case"serverCert":b.certificateObject.cert=a,b.certificateObject.$save({type:"cert"},function(){b.uploadSuccess("serverCert",d)},function(a){b.uploadFail(a,"serverCert",d)});break;case"serverKey":b.certificateObject.key=a,b.certificateObject.$save({type:"key"},function(){b.uploadSuccess("serverKey",d)},function(a){b.uploadFail(a,"serverKey",d)});break;case"trustedCerts":b.certificateObject.cert=a,b.certificateObject.$save({type:"ca",property:"cert"},function(){b.uploadSuccess("trustedCerts",d)},function(a){b.uploadFail(a,"trustedCerts",d)})}g++,b.importProgressStatus=Math.floor(g/c),g===c&&(b.importProgressStatus=100,b.importProgressType="success")},b.$watch("serverCert",function(){b.upload(b.serverCert),b.uploadType="serverCert"}),b.$watch("serverKey",function(){b.upload(b.serverKey),b.uploadType="serverKey"}),b.$watch("trustedCerts",function(){b.upload(b.trustedCerts),b.uploadType="trustedCerts"}),b.upload=function(a){if(a&&a.length){b.serverRestartError=!1;var c=function(c){return function(d){var e=d.target.result;b.uploadCertificate(e,a.length,c.name)}};b.showImportResults=!1;for(var d=0;d<a.length;d++){var e=a[d],f=new FileReader;f.onload=c(e),"trustedCerts"===b.uploadType&&(b.showImportResults=!0),f.readAsText(e)}}},b.addPassphrase=function(){f.AlertReset(),b.certificateObject=new e.Keystore,b.certificateObject.passphrase=b.serverPassphrase,b.certificateObject.$save({type:"passphrase"},function(){b.passphraseSuccess("serverKey","")},function(a){b.passphraseFail(a,"serverKey","")})},b.passphraseSuccess=function(a){e.Keystore.get({type:"validity"},function(c){b.certValidity=c,b.passPhraseValid=!0,f.AlertAddMsg(a,"success","Passphrase matches supplied key"),b.importSuccess++,b.serverRestartRequired=!0,b.resetCertificates(),b.goToTop()},function(){b.passphraseFail(a)}),b.serverPassphrase=null},b.passphraseFail=function(a){f.AlertAddMsg(a,"danger","The passphrase does not match the key"),b.passPhraseValid=!1,b.serverRestartRequired=!0,b.resetCertificates()};var g=function(){b.resetCertificates(),b.serverRestartRequired=!0,b.goToTop(),f.AlertAddMsg("trustedCertDelete","success","The Trusted Certificate has been deleted successfully")},h=function(a){f.AlertAddMsg("trustedCertDelete","danger","An error has occurred while deleting the trusted certificate: #"+a.status+" - "+a.data)};b.confirmDelete=function(a){f.AlertReset();var b={title:"Delete Trusted Certificate",button:"Delete",message:'Are you sure you wish to delete the Trusted Certificate "'+a.commonName+'"?'},c=d.open({templateUrl:"views/confirmModal.html",controller:"ConfirmModalCtrl",resolve:{confirmObject:function(){return b}}});c.result.then(function(){var b=new e.Keystore;b.$remove({type:"ca",property:a._id},g,h)},function(){})},b.restartServerLater=function(){b.serverRestartRequired=!1},b.restartServer=function(){var a=new e.Restart;a.$save({},function(){b.serverRestarting=!0,b.serverRestartRequired=!1,b.restartTimeout=10;var a=c(function(){b.restartTimeout--,0===b.restartTimeout&&(b.serverRestarting=!1,b.resetCertificates(),c.cancel(a))},1e3)},function(){b.serverRestartRequired=!1,b.serverRestartError=!0})},b.addCert=function(a){f.AlertReset(),b.serverRestarting=!1,d.open({templateUrl:"views/certificateModal.html",controller:"CertificatesModalCtrl",resolve:{cert:function(){},certType:function(){return a}}})}}]),angular.module("openhimConsoleApp").controller("CertificatesModalCtrl",["$rootScope","$scope","$modalInstance","$timeout","Api","Notify","Alerting","certType",function(a,b,c,d,e,f,g,h){var i=null,j=function(){f.notify("certificatesChanged")},k=function(a,b){var c;try{c=new Blob([a],{type:b})}catch(d){var e=function(){window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder};if("TypeError"===d.name&&window.BlobBuilder){var f=new e;f.append(a),c=f.getBlob(b)}else c="InvalidStateError"===d.name?new Blob([a],{type:b}):{error:"Browser not supported for Blob creation"}}return c},l=function(a){var b=new k(a,"application/text");return b.error?void 0:(null!==i&&window.URL.revokeObjectURL(i),window.URL.createObjectURL(b))},m=function(a){g.AlertAddMsg("top","success","The certificate has been created, download the key and cert below.");var c=l(a.key);if(b.downloadKeyLink=angular.copy(c),c){var d=l(a.certificate);d&&(b.downloadCertLink=d)}j()};b.downloadKeyFile=function(){b.downloadKeyLink=""},b.downloadCertFile=function(){b.downloadCertLink=""};var n=function(a){g.AlertAddMsg("top","danger","An error has occurred while creating the certificate: #"+a.status+" - "+a.data),j()};b.cancel=function(){c.dismiss("cancel")},b.validateFormCertificates=function(){g.AlertReset("hasErrors"),d.cancel(b.clearValidation),b.ngError={},b.ngError.hasErrors=!1,b.cert.days||(b.ngError.days=!0,b.ngError.hasErrors=!0),b.cert.commonName||(b.ngError.commonName=!0,b.ngError.hasErrors=!0),b.cert.country&&2!==b.cert.country.length&&(b.ngError.country=!0,b.ngError.hasErrors=!0),b.cert.country=angular.uppercase(b.cert.country)},b.submitFormCertificate=function(){b.validateFormCertificates(),b.ngError.hasErrors===!1&&b.save(b.cert)},b.cert=new e.Certificates,b.cert.type=h;var o=function(a){b.keyName=a.commonName+".key.pem",b.certName=a.commonName+".cert.crt",b.certBackup=angular.copy(a),b.update?a.$update(m,n):a.$save({},m,n)};b.save=function(a){o(a)}}]),angular.module("openhimConsoleApp").controller("ExportImportCtrl",["$upload","$scope","$modal","Api","Alerting",function(a,b,c,d,e){b.downloadLink="",b.validatedData={},b.resetExportOptions=function(){b.selectedExports={},b.selectedExports.Users=b.exportCollections.Users,b.selectedExports.Clients=b.exportCollections.Clients,b.selectedExports.Channels=b.exportCollections.Channels,b.selectedExports.Mediators=b.exportCollections.Mediators,b.selectedExports.ContactGroups=b.exportCollections.ContactGroups,b.selectedExports.Keystore=b.exportCollections.Keystore,b.showRecordOptions={},b.showRecordOptions.Users=!1,b.showRecordOptions.Clients=!1,b.showRecordOptions.Channels=!1,b.showRecordOptions.Mediators=!1,b.showRecordOptions.ContactGroups=!1,b.showRecordOptions.Keystore=!1};var f=function(a){b.exportCollections=a[0],b.exportSettings={},b.resetExportOptions()},g=function(a){e.AlertReset(),e.AlertAddMsg("top","danger","An error has occurred while fetching metadata: #"+a.status+" - "+a.data)},h=function(){var a=c.open({templateUrl:"views/exportImportModal.html",controller:"ExportImportModalCtrl",resolve:{data:function(){return b.validatedData}}});a.result.then(function(a){b.importStatus="done",b.importResults=a})};d.Metadata.query(function(a){f(a)},function(a){g(a)}),b.toggleCollectionExportSelection=function(a,c){b.selectedExports[a]===c?(b.selectedExports[a]=[],b.showRecordOptions[a]=!0):(b.selectedExports[a]=c,b.showRecordOptions[a]=!1)},b.toggleRecordExportSelection=function(a,c){var d=b.selectedExports[a].indexOf(c);d>-1?b.selectedExports[a].splice(d,1):b.selectedExports[a].push(c)},b.removeProperties=function(a){var c="_id",d="__v";for(var e in a)e===c||e===d?delete a[e]:("object"==typeof a[e]||a[e]instanceof Array)&&b.removeProperties(a[e]);return a},b.createExportFile=function(){var a=angular.copy(b.selectedExports),c=null,d=function(a){var b=buildBlob(a,"application/json");return b.error?void 0:(null!==c&&window.URL.revokeObjectURL(c),c=window.URL.createObjectURL(b))};a=JSON.stringify(b.removeProperties(a),null,2),b.importScriptName="openhim-insert.json";var e=d(a);e&&(b.downloadLink=e)},b.downloadExportFile=function(){b.downloadLink=""};var i=function(a){e.AlertReset(),e.AlertAddMsg("top","danger","An error has occurred while validating the import: #"+a.status+" - "+a.data)},j=function(a){b.importStatus="resolvingConflicts",b.validatedData=a,h()};b.validateImportFile=function(a){b.importStatus="progress",d.MetadataValidation.save(a,j,i)},b.$watch("files",function(){b.upload(b.files)}),b.upload=function(a){if(a&&a.length){var c=new FileReader;c.onload=function(a){b.validateImportFile(a.target.result)};for(var d=0;d<a.length;d++){var e=a[d];c.readAsText(e)}}},b.viewRecordDetails=function(a,b){c.open({templateUrl:"views/transactionsBodyModal.html",controller:"TransactionsBodyModalCtrl",windowClass:"modal-fullview",resolve:{bodyData:function(){return{type:a,content:b,headers:{"content-type":"application/json"}}}}})},b.showConflictModal=function(){h()},b.numberOfSuccessfulImports=function(){return b.importResults.filter(function(a){return"Error"!==a.status}).length},b.numberOfFailedImports=function(){return b.importResults.filter(function(a){return"Error"===a.status}).length},b.areThereAnyImports=function(){return b.importResults&&b.importResults.length>0?!0:!1}}]),angular.module("openhimConsoleApp").controller("ExportImportModalCtrl",["$scope","$modalInstance","$modal","$timeout","Api","Alerting","data",function(a,b,c,d,e,f,g){a.outcome={selectedAll:!1},a.ngErrors={},a.conflicts=[],a.validImports=[],a.invalidImports=[],a.importStatus="resolvingConflicts";for(var h=0;h<g.length;h++)"Conflict"===g[h].status?(g[h].action="ignore","Keystore"===g[h].model&&(g[h].duplicatePrevented=!0),a.conflicts.push(g[h])):"Valid"===g[h].status?a.validImports.push(g[h]):"Error"===g[h].status&&a.invalidImports.push(g[h]);a.cancel=function(){d.cancel(a.clearValidationRoute),b.dismiss("cancel")},a.resetErrors=function(){f.AlertReset(),a.ngErrors.hasErrors=!1,angular.forEach(a.conflicts,function(a){a.errMsg=void 0})};var i=function(a){f.AlertReset(),f.AlertAddMsg("top","danger","An error has occurred during the import: #"+a.status+" - "+a.data)},j=function(c,d){a.importStatus="done",b.close(c),d&&d()};a.runImportFile=function(a,b){e.Metadata.save(a,function(a){j(a,b)},i)},a.validateImport=function(b){return angular.forEach(a.conflicts,function(a){if(a.action&&"duplicate"===a.action){var b="Needs to be different to original uid.";"Channels"===a.model&&a.record.name===a.uid?a.errMsg=b:"Clients"===a.model&&a.record.clientID===a.uid?a.errMsg=b:"Mediators"===a.model&&a.record.urn===a.uid?a.errMsg=b:"Users"===a.model&&a.record.email===a.uid?a.errMsg=b:"ContactGroups"===a.model&&a.record.groups===a.uid&&(a.errMsg=b)}}),a.ngErrors.hasErrors=a.conflicts.some(function(a){return a.errMsg&&a.errMsg.length>0}),a.ngErrors.hasErrors&&(a.clearValidationRoute=d(function(){console.log("reset errors"),a.resetErrors()},5e3),f.AlertAddMsg("hasErrorsImport","danger","There are errors on the import form.")),b?void b(!a.ngErrors.hasErrors):!a.ngErrors.hasErrors},a.saveImport=function(c){a.validateImport(function(d){d&&(a.importStatus="progress",a.resolvedData={Channels:[],Clients:[],Mediators:[],Users:[],ContactGroups:[],Keystore:[]},angular.forEach(a.conflicts,function(b){b.action&&"duplicate"===b.action&&("Channels"===b.model?b.record.name=b.uid:"Clients"===b.model?b.record.clientID=b.uid:"Mediators"===b.model?b.record.urn=b.uid:"Users"===b.model?b.record.email=b.uid:"ContactGroups"===b.model&&(b.record.groups=b.uid)),b.action&&"ignore"!==b.action&&("Channels"===b.model?a.resolvedData.Channels.push(b.record):"Clients"===b.model?a.resolvedData.Clients.push(b.record):"Mediators"===b.model?a.resolvedData.Mediators.push(b.record):"Users"===b.model?a.resolvedData.Users.push(b.record):"ContactGroups"===b.model?a.resolvedData.ContactGroups.push(b.record):"Keystore"===b.model&&a.resolvedData.Keystore.push(b.record))}),angular.forEach(a.validImports,function(b){"Channels"===b.model?a.resolvedData.Channels.push(b.record):"Clients"===b.model?a.resolvedData.Clients.push(b.record):"Mediators"===b.model?a.resolvedData.Mediators.push(b.record):"Users"===b.model?a.resolvedData.Users.push(b.record):"ContactGroups"===b.model?a.resolvedData.ContactGroups.push(b.record):"Keystore"===b.model&&a.resolvedData.Keystore.push(b.record)}),a.resolvedData.Channels.length>0||a.resolvedData.Clients.length>0||a.resolvedData.Users.length>0||a.resolvedData.Mediators.length>0||a.resolvedData.ContactGroups.length>0||a.resolvedData.Keystore.length>0?a.runImportFile(a.resolvedData,c):(b.close(),c&&c("Nothing to import")))})},a.viewRecordDetails=function(a,b){c.open({templateUrl:"views/transactionsBodyModal.html",controller:"TransactionsBodyModalCtrl",windowClass:"modal-fullview",resolve:{bodyData:function(){return{type:a,content:b,headers:{"content-type":"application/json"}}}}})},a.selectAll=function(){angular.forEach(a.conflicts,function(b){b.action=a.outcome.selectedAll?"overwrite"===b.action?"ignore":b.action:"overwrite"})},a.checkIfAllOverwrites=function(){a.outcome.selectedAll=a.conflicts.every(function(a){return"overwrite"===a.action})},a.checkIfAllOverwrites()}]),angular.module("openhimConsoleApp").controller("AuditsCtrl",["$scope","$modal","$location","$interval","Api","Alerting","AuditLookups",function(a,b,c,d,e,f,g){a.isCollapsed=!0;var h,i=moment(),j=0;a.baseIndex=0;var k=5e3;e.AuditsFilterOptions.get(function(b){a.auditsFilterOptions=b},function(a){console.log("Audits error: "+a)});var l=function(){a.showpage=0,a.showlimit=10,a.eventActionMap=g.eventActionMap(),a.eventOutcomeMap=g.eventOutcomeMap(),a.settings={},a.settings.filter={},a.settings.filter.limit=c.search().limit?c.search().limit:10,a.settings.filter.dateStart=c.search().dateStart?c.search().dateStart:"",a.settings.filter.dateEnd=c.search().dateEnd?c.search().dateEnd:"",a.settings.list={},a.settings.list.tabview="same",a.settings.list.autoupdate=!0,a.filters={},a.filters.eventIdentification={},c.search().eventID&&(a.filters.eventIdentification.eventID=c.search().eventID),c.search().eventTypeCode&&(a.filters.eventIdentification.eventTypeCode=c.search().eventTypeCode),c.search().eventActionCode&&(a.filters.eventIdentification.eventActionCode=c.search().eventActionCode),c.search().eventOutcomeIndicator&&(a.filters.eventIdentification.eventOutcomeIndicator=c.search().eventOutcomeIndicator),a.filters.participantObjectIdentification={},a.filters.participantObjectIdentification.patientID={},c.search().patientID&&(a.filters.participantObjectIdentification.patientID.patientID=c.search().patientID),c.search().assigningAuth&&(a.filters.participantObjectIdentification.patientID.assigningAuth=c.search().assigningAuth),c.search().assigningAuthID&&(a.filters.participantObjectIdentification.patientID.assigningAuthID=c.search().assigningAuthID),c.search().participantObjectID&&(a.filters.participantObjectIdentification.participantObjectID=c.search().participantObjectID),c.search().participantObjectIDTypeCode&&(a.filters.participantObjectIdentification.participantObjectIDTypeCode=c.search().participantObjectIDTypeCode),a.filters.participantObjectIdentification.participantObjectDetail={},c.search().participantObjectDetailType&&(a.filters.participantObjectIdentification.participantObjectDetail.type=c.search().participantObjectDetailType),c.search().participantObjectDetailValue&&(a.filters.participantObjectIdentification.participantObjectDetail.value=c.search().participantObjectDetailValue),a.filters.activeParticipant={},c.search().userID&&(a.filters.activeParticipant.userID=c.search().userID),c.search().roleIDCode&&(a.filters.activeParticipant.roleIDCode=c.search().roleIDCode),c.search().alternativeUserID&&(a.filters.activeParticipant.alternativeUserID=c.search().alternativeUserID),c.search().networkAccessPointID&&(a.filters.activeParticipant.networkAccessPointID=c.search().networkAccessPointID),a.filters.auditSourceIdentification={},c.search().auditSourceID&&(a.filters.auditSourceIdentification.auditSourceID=c.search().auditSourceID)};l();var m=localStorage.getItem("consoleSession");m=JSON.parse(m),a.consoleSession=m;var n=m.sessionUserSettings;n&&(n.filter&&n.filter.limit&&0!==n.filter.limit&&""===n.filter.limit&&(a.settings.filter.limit=n.filter.limit),n.list&&(a.settings.list.tabview=n.list.tabview)),a.returnFilters=function(b){var c,d,e={},f="";if(e.filterPage=a.showpage,e.filterLimit=a.showlimit,f+="&limit="+a.settings.filter.limit,e.filters={},c=a.settings.filter.dateStart,d=a.settings.filter.dateEnd,c&&d){var g=moment(c).format(),h=moment(d).endOf("day").format();e.filters["eventIdentification.eventDateTime"]=JSON.stringify({$gte:g,$lte:h})}c&&(f+="&dateStart="+moment(c).format("YYYY-MM-DD")),d&&(f+="&dateEnd="+moment(d).format("YYYY-MM-DD"));var i=a.filters.participantObjectIdentification.patientID.patientID,j=a.filters.participantObjectIdentification.patientID.assigningAuth,k=a.filters.participantObjectIdentification.patientID.assigningAuthID;(null===j||void 0===j||""===j)&&(j=".*"),(null===k||void 0===k||""===k)&&(k=".*");var l=i+"\\^\\^\\^"+j+"&"+k+"&.*";valueNotEmpty(i)===!0&&(e.filters["participantObjectIdentification.participantObjectID"]=JSON.stringify(l),f+="&patientID="+i);var m=a.filters.eventIdentification.eventTypeCode;if(valueNotEmpty(m)===!0){var n=m.split("---");e.filters["eventIdentification.eventTypeCode.code"]=n[0],e.filters["eventIdentification.eventTypeCode.codeSystemName"]=n[1],e.filters["eventIdentification.eventTypeCode.displayName"]=n[2],f+="&eventTypeCode="+m}var o=a.filters.eventIdentification.eventID;if(valueNotEmpty(o)===!0){var p=o.split("---");e.filters["eventIdentification.eventID.code"]=p[0],e.filters["eventIdentification.eventID.codeSystemName"]=p[1],e.filters["eventIdentification.eventID.displayName"]=p[2],f+="&eventID="+o}var q=a.filters.eventIdentification.eventActionCode;valueNotEmpty(q)===!0&&(e.filters["eventIdentification.eventActionCode"]=q,f+="&eventActionCode="+q);var r=a.filters.eventIdentification.eventOutcomeIndicator;valueNotEmpty(r)===!0&&(e.filters["eventIdentification.eventOutcomeIndicator"]=r,f+="&eventOutcomeIndicator="+r);var s=a.filters.activeParticipant.userID;valueNotEmpty(s)===!0&&(e.filters["activeParticipant.userID"]=s,f+="&userID="+s);var t=a.filters.activeParticipant.alternativeUserID;valueNotEmpty(t)===!0&&(e.filters["activeParticipant.alternativeUserID"]=t,f+="&alternativeUserID="+t);var u=a.filters.activeParticipant.networkAccessPointID;valueNotEmpty(u)===!0&&(e.filters["activeParticipant.networkAccessPointID"]=u,f+="&networkAccessPointID="+u);var v=a.filters.activeParticipant.roleIDCode;if(valueNotEmpty(v)===!0){var w=v.split("---");e.filters["activeParticipant.roleIDCode.code"]=w[0],e.filters["activeParticipant.roleIDCode.codeSystemName"]=w[1],e.filters["activeParticipant.roleIDCode.displayName"]=w[2],f+="&roleIDCode="+v}var x=a.filters.participantObjectIdentification.participantObjectID;valueNotEmpty(x)===!0&&(f+="&participantObjectID="+x,e.filters["participantObjectIdentification.participantObjectID"]=valueNotEmpty(i)===!0?{type:"AND",patientID:l,objectID:x}:JSON.stringify(x));var y=a.filters.participantObjectIdentification.participantObjectIDTypeCode;if(valueNotEmpty(y)===!0){var z=y.split("---");e.filters["participantObjectIdentification.participantObjectIDTypeCode.code"]=z[0],e.filters["participantObjectIdentification.participantObjectIDTypeCode.codeSystemName"]=z[1],e.filters["participantObjectIdentification.participantObjectIDTypeCode.displayName"]=z[2],f+="&participantObjectIDTypeCode="+y}var A=a.filters.participantObjectIdentification.participantObjectDetail.type;valueNotEmpty(A)===!0&&(e.filters["participantObjectIdentification.participantObjectDetail.type"]=A,f+="&participantObjectDetailType="+A);var B=a.filters.participantObjectIdentification.participantObjectDetail.value;valueNotEmpty(B)===!0&&(e.filters["participantObjectIdentification.participantObjectDetail.value"]=B,f+="&participantObjectDetailValue="+B);var C=a.filters.auditSourceIdentification.auditSourceID;return valueNotEmpty(C)===!0&&(e.filters["auditSourceIdentification.auditSourceID"]=C,f+="&auditSourceID="+C),"urlParams"===b?f:"filtersObject"===b?e:void 0};var o=function(b){a.audits=b,b.length<a.showlimit?(jQuery("#loadMoreBtn").hide(),0===b.length&&f.AlertAddMsg("bottom","warning","There are no audits for the current filters")):jQuery("#loadMoreBtn").show()},p=function(a){jQuery("#loadMoreBtn").hide(),f.AlertAddServerMsg(a.status)};a.applyFilterIfValidDate=function(b){moment(b,"YYYY-MM-DD",!0).isValid()&&a.applyFiltersToUrl()},a.applyFiltersToUrl=function(){var b=window.location.hash,d=a.returnFilters("urlParams"),e="/audits?"+d.substring(1);if(b===e)a.refreshAuditsList();else{var f=c.absUrl(),g=c.url(),h=f.replace(g,"");window.location=h+e}},a.refreshAuditsList=function(){a.audits=null,f.AlertReset(),a.showpage=0,a.showlimit=a.settings.filter.limit,e.Audits.query(a.returnFilters("filtersObject"),o,p)},a.refreshAuditsList();var q=function(b){a.audits=a.audits.concat(b),a.audits=jQuery.unique(a.audits),b.length<a.showlimit&&(jQuery("#loadMoreBtn").hide(),f.AlertAddMsg("bottom","warning","There are no more audits to retrieve")),a.busyLoadingMore=!1},r=function(a){jQuery("#loadMoreBtn").hide(),f.AlertAddServerMsg(a.status)};a.loadMoreAudits=function(){a.busyLoadingMore=!0,f.AlertReset(),a.showpage++;var b=a.returnFilters("filtersObject");

b.filters["eventIdentification.eventDateTime"]||(b.filters["eventIdentification.eventDateTime"]=JSON.stringify({$lte:moment(i-j).format()})),e.Audits.query(b,q,r)},a.viewAuditDetails=function(b,d){if("TD"===d.target.tagName){var e=c.absUrl(),f=c.url(),g=e.replace(f,""),h=g+"/"+b;a.settings.list.tabview&&"new"===a.settings.list.tabview?window.open(h,"_blank"):c.path(b)}},a.clearFilters=function(){a.settings.filter.limit=10,a.settings.filter.dateStart="",a.settings.filter.dateEnd="",a.settings.list.tabview="same";var b=angular.copy(c.search());c.search({});var d=angular.copy(c.search());angular.equals(b,d)&&a.refreshAuditsList()};var s;a.pollForLatest=function(){var b=a.returnFilters("filtersObject");b.filters["eventIdentification.eventDateTime"]||(b.filters["eventIdentification.eventDateTime"]=JSON.stringify({$gte:moment(h).format(),$lte:moment().format()}),h=moment()-j,delete b.filterPage,delete b.filterLimit,e.Audits.query(b,function(b){b.forEach(function(b){a.audits.unshift(b),a.baseIndex--})}))},a.startPolling=function(){s||(s=d(function(){a.pollForLatest()},k))},a.stopPolling=function(){angular.isDefined(s)&&(d.cancel(s),s=void 0)},e.Heartbeat.get(function(b){j=moment()-moment(b.now),h=moment()-j,a.settings.list.autoupdate&&a.startPolling()}),a.$on("$destroy",a.stopPolling)}]),angular.module("openhimConsoleApp").controller("AuditDetailsCtrl",["$scope","$modal","$location","$routeParams","Api","Alerting","AuditLookups",function(a,b,c,d,e,f,g){a.eventActionMap=g.eventActionMap(),a.eventOutcomeMap=g.eventOutcomeMap();var h=function(b){a.auditDetails=b},i=function(a){f.AlertAddServerMsg(a.status)};e.Audits.get({auditId:d.auditId},h,i),a.returnFilterObject=function(){var a={};return a.filterPage=0,a.filterLimit=0,a.parentID=d.auditId,a},a.viewTransactionDetails=function(a){c.path(a)},a.viewContentDetails=function(a,c){b.open({templateUrl:"views/auditsContentModal.html",controller:"AuditsContentModalCtrl",resolve:{auditData:function(){return{type:a,content:c}}}})}}]),angular.module("openhimConsoleApp").controller("AuditsContentModalCtrl",["$scope","$modalInstance","auditData",function(a,b,c){if(a.auditData=c,"Raw Audit Message"===c.type){var d=beautifyIndent("application/xml",c.content);a.auditData.content=d.content,a.bodyTransformLang=d.lang}else isBase64String(c.content)&&(a.auditData.content=decodeBase64(c.content));a.cancel=function(){b.dismiss("cancel")}}]),angular.module("openhimConsoleApp").controller("LogsCtrl",["$scope","$location","Api",function(a,b,c){function d(a){return new moment(a.timestamp).format("YYYY-MM-DD HH:mm:ss.SSS")+" - "+a.level+": ["+a.label+"] "+a.message+"\n"}function e(){var b=new Date,e={from:new Date(f).toISOString(),until:b.toISOString(),level:a.params.level};f=b,c.Logs.query(e,function(b){b.forEach(function(b){a.logs+=d(b),h++,h>1e4&&(a.logs=a.logs.substring(a.logs.indexOf("\n")+1))})})}var f,g=b.search();a.params=angular.equals({},g)?{level:"info"}:g,a.logs="";var h=0;a.params.from||a.params.until?(a.autoupdate=!1,a.tailLogs=!1):(a.autoupdate=!0,a.tailLogs=!0),a.logs="",f=new Date;var i,j;a.params.from&&a.params.from.length>0&&(i=moment(a.params.from).format()),a.params.until&&a.params.until.length>0&&(j=moment(a.params.until).format());var k={from:i,until:j,level:a.params.level};a.params.until||(k.until=f.toISOString()),c.Logs.query(k,function(b){b.forEach(function(b){a.logs+=d(b)})});var l=setInterval(function(){a.autoupdate&&e()},1e3),m=setInterval(function(){if(a.tailLogs===!0){var b=document.getElementById("textarea");b.scrollTop=b.scrollHeight}},50);a.reload=function(){b.search(a.params)},a.$on("$locationChangeStart",function(){clearInterval(l),clearInterval(m)}),a.reset=function(){delete a.params.from,delete a.params.until,a.params.level="info",a.reload()}}]),angular.module("openhimConsoleApp").controller("AboutCtrl",["$scope","$interval","Api","Alerting","config",function(a,b,c,d,e){a.aboutInfo={};var f=function(c){a.aboutInfo=c,h(),a.updateTime(c.serverTimezone),a.clock=b(function(){a.updateTime(c.serverTimezone)},1e3)},g=function(a){d.AlertAddServerMsg(a.status)};c.About.get(f,g),a.updateTime=function(b){a.aboutInfo.serverTime=getTimeForTimezone(b)};var h=function(){a.aboutInfo.currentConsoleVersion=e.version,a.aboutInfo.minimumCoreVersion=e.minimumCoreVersion;var b=parseInt(e.minimumCoreVersion.split(".")[0])+1;a.aboutInfo.maximumCoreVersion=b+".0.0",a.aboutInfo.compatible=isCoreVersionCompatible(a.aboutInfo.minimumCoreVersion,a.aboutInfo.currentCoreVersion)};a.$on("$destroy",function(){angular.isDefined(a.clock)&&b.cancel(a.clock)})}]);var valueNotEmpty=function(a){return null!==a&&void 0!==a&&""!==a?!0:!1};angular.module("openhimConsoleApp").directive("focus",["$timeout",function(a){return{scope:{trigger:"@focus"},link:function(b,c){b.$watch("trigger",function(b){"true"===b&&a(function(){c[0].focus()})})}}}]),angular.module("openhimConsoleApp").directive("footerVersion",["Api","config",function(a,b){return{template:'<span ng-class="{ \'version-danger-text\': footerVersionsCompatible == false }" ng-if="footerConsoleVersion && footerCoreVersion">(Console <strong>v{{ footerConsoleVersion }}</strong> | Core <strong>v{{ footerCoreVersion }}</strong>)</span>',scope:!1,link:function(c){var d=function(a){c.footerCoreVersion=a.currentCoreVersion,c.footerConsoleVersion=b.version,c.footerVersionsCompatible=isCoreVersionCompatible(b.minimumCoreVersion,c.footerCoreVersion)};c.$root.$watch("sessionUser",function(b){b?a.About.get(d):(c.footerCoreVersion=null,c.footerConsoleVersion=null)})}}}]),angular.module("openhimConsoleApp").directive("morrisLineChart",["$parse",function(a){return{restrict:"EA",link:function(b,c,d){var e=d.id,f=a(d.data);b.$watchCollection(f,function(a){var c=a;c&&(b.morrisLineChart?b.morrisLineChart.setData(c.data):b.morrisLineChart=new Morris.Line({element:e,data:c.data,xkey:c.xkey,ykeys:c.ykeys,labels:c.labels,postUnits:c.postunits,resize:!0}))})}}}]).directive("morrisBarChart",["$parse",function(a){return{restrict:"EA",link:function(b,c,d){var e=d.id,f=a(d.data);b.$watchCollection(f,function(a){var c=a;c&&(b.morrisBarChart?b.morrisBarChart.setData(c.data):b.morrisBarChart=new Morris.Bar({element:e,data:c.data,xkey:c.xkey,ykeys:c.ykeys,labels:c.labels,barColors:c.colors,stacked:c.stacked,barRatio:.4,xLabelMargin:10,resize:!0,hideHover:"auto"}).on("click",function(a,b){b.link&&viewPage(b.link)}))})}}}]).directive("morrisDonutChart",["$parse",function(a){return{restrict:"EA",link:function(b,c,d){var e=d.id,f=a(d.data);b.$watchCollection(f,function(a){var d=a;c.empty(),d&&(b.morrisDonutChart=new Morris.Donut({element:e,data:d.data,colors:d.colors,resize:!0,formatter:function(a){return a+"%"}}))})}}}]),angular.module("openhimConsoleApp").directive("mediatorConfig",function(){return{restrict:"EA",scope:{configDefs:"=",config:"="},templateUrl:"views/partials/mediator-config.html",link:function(a){a.inputKeys={},a.inputValues={},a.removeMapping=function(b,c){delete a.config[b][c]},a.addNewMapping=function(b){a.config[b]||(a.config[b]={}),a.config[b][a.inputKeys[b]]=a.inputValues[b],a.inputKeys[b]="",a.inputValues[b]=""},a.doesNewKeyExist=function(b){return a.config[b]&&a.config[b][a.inputKeys[b]]},a.isNewKeyValid=function(b){return a.inputKeys[b]&&!a.doesNewKeyExist(b)},a.inputKeysForArrays={},a.inputValuesForArrays={},a.removeMappingInArray=function(b,c,d){delete a.config[b][c][d]},a.addNewMappingInArray=function(b,c){a.config[b][c]||(a.config[b][c]={}),a.config[b][c][a.inputKeysForArrays[b+c]]=a.inputValuesForArrays[b+c],a.inputKeysForArrays[b+c]="",a.inputValuesForArrays[b+c]=""},a.doesNewKeyExistInArray=function(b,c){return a.config[b][c]&&a.config[b][c][a.inputKeysForArrays[b+c]]},a.isNewKeyValidInArray=function(b,c){return a.inputKeysForArrays[b+c]&&!a.doesNewKeyExistInArray(b,c)},a.removeArrayItem=function(b,c){a.config[b].splice(c,1)},a.addNewArrayItem=function(b){a.config[b.param]||(a.config[b.param]=[]);var c="";switch(b.type){case"bool":c=!1;break;case"number":c=0;break;case"option":c=b.values[0];break;case"map":c={};break;case"struct":c={}}a.config[b.param].push(c)}}}}).directive("mediatorNestedConfig",["$compile",function(a){return{restrict:"EA",scope:{configDefs:"=",config:"="},template:"<div/>",link:function(b,c){b.configDefs&&(b.config||(b.config={}),c.append('<div mediator-config config-defs="configDefs" config="config"></div>'),a(c.contents())(b))}}}]),angular.module("openhimConsoleApp").directive("mediatorConfigDisplay",function(){return{restrict:"EA",scope:{configDefs:"=",config:"="},templateUrl:"views/partials/mediator-config-display.html",link:function(a){a.mediatorDefsMap={},a.$watch("configDefs",function(b){b&&b.map(function(b){a.mediatorDefsMap[b.param]=b})})}}}).directive("mediatorNestedConfigDisplay",["$compile",function(a){return{restrict:"EA",scope:{configDefs:"=",config:"="},template:"<div/>",link:function(b,c){b.config&&(c.append('<div mediator-config-display config-defs="configDefs" config="config"></div>'),a(c.contents())(b))}}}]),angular.module("openhimConsoleApp").directive("metricsDateTypeSelector",function(){return{restrict:"EA",templateUrl:"views/partials/metrics-date-type-selector.html",scope:{selectedDateType:"=",onChange:"=?"},link:function(a){function b(){var b=moment(a.selectedDateType.from),c=moment(a.selectedDateType.until),d=function(a){return Math.abs(b.diff(c,a))},e=120;b.isAfter(c)&&(a.selectedDateType.from=a.selectedDateType.until),a.optionsEnabled.minute=!0,a.optionsEnabled.hour=!0,a.optionsEnabled.day=!0,a.optionsEnabled.week=!0,a.optionsEnabled.month=!0,a.optionsEnabled.year=!0,d("minutes")>e&&(a.optionsEnabled.minute=!1,"minute"===a.selectedDateType.type&&(a.selectedDateType.type="hour")),d("hours")>e&&(a.optionsEnabled.hour=!1,"hour"===a.selectedDateType.type&&(a.selectedDateType.type="day")),d("days")>e&&(a.optionsEnabled.day=!1,"day"===a.selectedDateType.type&&(a.selectedDateType.type="week")),d("weeks")>e&&(a.optionsEnabled.week=!1,"week"===a.selectedDateType.type&&(a.selectedDateType.type="month")),d("months")>e&&(a.optionsEnabled.month=!1,"month"===a.selectedDateType.type&&(a.selectedDateType.type="year"))}a.optionsEnabled={minute:!0,hour:!0,day:!0,week:!0,month:!0,year:!0},a.onChange||(a.onChange=function(){}),a.customDateBreakdownChange=function(){b(),a.onChange()},b()}}}),angular.module("openhimConsoleApp").directive("transactionBodyDownloader",["Api",function(a){return{restrict:"EA",template:'<div class="btn btn-primary" ng-click="download()" tooltip="Download body"><i class="glyphicon glyphicon-download-alt"></i></div>',scope:{transactionId:"=",path:"="},link:function(b){b.downloadHandler=saveAs,b.download=function(){var c=function(a){var c=_.get(a,b.path),d="text/plain";c.headers&&c.headers["content-type"]&&(d=c.headers["content-type"]);var e;e=d.indexOf("json")>-1?".json":d.indexOf("xml")>-1?".xml":".txt";var f=buildBlob(c.body,d),g=b.transactionId+"_"+_.camelCase(b.path)+e;b.downloadHandler(f,g)},d=function(a){console.log(a)};a.Transactions.get({transactionId:b.transactionId,filterRepresentation:"full"},c,d)}}}}]),angular.module("openhimConsoleApp").directive("visualizer",["$parse",function(a){return{restrict:"EA",template:'<div id="visualizer"></div>',link:function(b,c,d){function e(a){for(var b=0;b<M.length;b++)if(M[b].eventType===a.type&&M[b].eventName.toLowerCase()===a.name.toLowerCase())return M[b].rect;return null}function f(a){for(var b=0;b<N.length;b++)if(N[b].eventType===a.type&&N[b].eventName.toLowerCase()===a.name.toLowerCase())return N[b].text;return null}function g(a){for(var b=0;b<O.length;b++)if(O[b].mediator===a.mediator)return O[b].rect;return null}function h(a,b,c,d,e,f,g){a.attr("rx",6).attr("ry",6).attr("x",c).attr("y",d).attr("width",e).attr("height",f).style("fill",B);var h=f/3.5;b.attr("x",c+e/2).attr("y",d+f/2+h/2).attr("text-anchor","middle").attr("font-size",h).text(g).style("fill",E)}function i(a,b,c,d,e){var f=t/M.length-2*v,g=u/4-2*v,i=d*f+v+d*v*2,j=0+v;h(a,b,i,j,f,g,e),c.attr("x1",i+f/2).attr("y1",j+g).attr("x2",i+f/2).attr("y2",A).style("stroke-width",t/150).style("stroke","#ddd")}function j(a,b,c,d,e){var f=t/O.length-2*v,g=u/4-2*v,i=d*f+v+d*v*2,j=x-g-.25*v;h(a,b,i,j,f,g,e)}function k(a,b,c){var d=t/N.length-2*v,e=(u/4-2*v)/3,f=b*d+v+b*v*2,g=u-v;a.attr("x",f+d/2).attr("y",g).attr("text-anchor","middle").attr("font-size",e).text(c).style("fill",B)}function l(a){r=a.append("svg:rect"),s=a.append("svg:text"),h(r,s,w,x,y,z,"Health Information Mediator"),a.append("svg:rect").attr("rx",6).attr("ry",6).attr("x",0+v).attr("y",A).attr("width",t-2*v).attr("height",u/50).style("fill",B),a.append("svg:rect").attr("rx",6).attr("ry",6).attr("x",0+v).attr("y",x+z+.25*v).attr("width",t-2*v).attr("height",u/50).style("fill",B)}function m(a){for(var b=0;b<M.length;b++)M[b].rect=a.append("svg:rect"),M[b].text=a.append("svg:text"),M[b].line=a.append("svg:line"),i(M[b].rect,M[b].text,M[b].line,b,M[b].display)}function n(a){for(var b=0;b<O.length;b++)O[b].rect=a.append("svg:rect"),O[b].text=a.append("svg:text"),O[b].line=a.append("svg:line"),j(O[b].rect,O[b].text,O[b].line,b,O[b].display)}function o(a){for(var b=0;b<N.length;b++)N[b].text=a.append("svg:text"),k(N[b].text,b,N[b].display)}function p(a,b,c,d){var e,f=1;if("start"===b.toLowerCase()?e=C:d?e=D:(e=B,c+=H),0>F?f=-1*F+1:F>0&&(f=1/(F+1)),a.transition().delay(c*f).style("fill",e),"start"===b.toLowerCase()||d){var g;g=d?1e3:G,a.transition().delay(c*f+g).style("fill",B)}}function q(a){if(0!==a.length){var b=a[0].normalizedTimestamp,c=function(a){return"undefined"!=typeof a&&null!==a&&"error"===a.toLowerCase()};angular.forEach(a,function(a){var d=null;if(d=e(a),null===d?(d=f(a),"undefined"!=typeof d&&null!==d&&(p(d,a.event,a.normalizedTimestamp-b,c(a.statusType)),p(r,a.event,a.normalizedTimestamp-b,c(a.statusType)))):p(d,a.event,a.normalizedTimestamp-b,c(a.statusType)),a.mediator){var h=g(a);p(h,a.event,a.normalizedTimestamp-b,c(a.statusType))}})}}var r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H,I,J=a(d.visData),K=a(d.visSettings),L=a(d.visSpeed),M=[],N=[],O=[];b.$watchCollection(L,function(a){void 0!==a&&(F=a)}),b.$watchCollection(K,function(a){a&&(d3.select("#visualizer").html(""),M=a.components,N=a.channels,O=a.mediators,t=a.visW,u=a.visH,v=a.pad,w=0+v,x=u/1.7,y=t-2*v,z=u/4-2*v,A=x-u/50-.25*v,O.length>0&&(A=A-(u/4-2*v)-.25*v),B=a.inactiveColor,C=a.activeColor,D=a.errorColor,E=a.textColor,F=a.speed,G=a.maxTimeout,H=a.minDisplayPeriod,a.visResponsive===!0?(I=d3.select("#visualizer").append("svg:svg").attr("viewBox","0 0 "+a.visW+" "+a.visH).attr("preserveAspectRatio","xMinYMin"),I.append("svg:rect").attr("width",a.visW).attr("height",a.visH)):I=d3.select("#visualizer").append("svg:svg").attr("width",a.visW).attr("height",a.visH),l(I),m(I),n(I),o(I))}),b.$watchCollection(J,function(a){a&&a.length>0&&q(a)})}}}]),angular.module("openhimConsoleApp").factory("Api",["$rootScope","$resource","config",function(a,b,c){var d=c.protocol,e=c.host,f=c.port,g=d+"://"+e+":"+f;return{Authenticate:b(g+"/authenticate/:email"),Channels:b(g+"/channels/:channelId",{channelId:"@_id"},{update:{method:"PUT"}}),TriggerPollingChannels:b(g+"/channels/:channelId/trigger",{channelId:"@_id"},{}),Roles:b(g+"/roles/:name",{name:"@name"},{update:{method:"PUT"}}),Users:b(g+"/users/:email",{email:"@email"},{update:{method:"PUT"}}),Clients:b(g+"/clients/:clientId/:property",{clientId:"@_id",property:"@property"},{update:{method:"PUT"}}),Transactions:b(g+"/transactions/:transactionId",{transactionId:"@_id"}),Mediators:b(g+"/mediators/:urn",{urn:"@urn"},{update:{method:"PUT"}}),MediatorConfig:b(g+"/mediators/:urn/config",{urn:"@urn"},{update:{method:"PUT"}}),MediatorChannels:b(g+"/mediators/:urn/channels",{urn:"@urn"}),MetricsChannels:b(g+"/metrics/channels/:channelId"),MetricsTimeseries:b(g+"/metrics/timeseries/:type"),MetricsTimeseriesChannel:b(g+"/metrics/timeseries/:type/channels/:channelId"),Tasks:b(g+"/tasks/:taskId",{taskId:"@_id"},{update:{method:"PUT"}}),ContactGroups:b(g+"/groups/:groupId",{groupId:"@_id"},{update:{method:"PUT"}}),Events:b(g+"/events/:receivedTime"),Heartbeat:b(g+"/heartbeat"),Restart:b(g+"/restart",{}),UserPasswordToken:b(g+"/token/:token",{token:"@token"},{update:{method:"PUT"}}),UserPasswordResetRequest:b(g+"/password-reset-request/:email",{email:"@email"},{}),Keystore:b(g+"/keystore/:type/:property",{type:"@type",property:"@property"},{update:{method:"PUT"}}),Certificates:b(g+"/certificates",{}),Audits:b(g+"/audits/:auditId",{auditId:"@_id"}),AuditsFilterOptions:b(g+"/audits-filter-options/",{}),Logs:b(g+"/logs"),Metadata:b(g+"/metadata",{},{save:{method:"POST",isArray:!0},query:{method:"GET",isArray:!0}}),MetadataValidation:b(g+"/metadata/validate",{},{save:{method:"POST",isArray:!0}}),Visualizers:b(g+"/visualizers/:id",{id:"@_id"},{update:{method:"PUT"}}),About:b(g+"/about")}}]),angular.module("openhimConsoleApp").factory("Notify",["$rootScope",function(a){var b={};return b.notify=function(b){a.$broadcast(b)},b}]),angular.module("openhimConsoleApp").factory("Authinterceptor",function(){var a=localStorage.getItem("loggedOnUser");return a=JSON.parse(a),{setLoggedInUser:function(b){a=b,localStorage.setItem("loggedOnUser",JSON.stringify(a))},getLoggedInUser:function(){var a=localStorage.getItem("loggedOnUser");return a=JSON.parse(a)},request:function(b){if(a){var c=a.passwordHash,d=CryptoJS.lib.WordArray.random(16).toString(),e=(new Date).toISOString();try{e=new Date(Math.abs((new Date).getTime()+a.timeDiff)).toISOString()}catch(f){console.log("Authinterceptor: "+f.message)}var g=a.email,h=CryptoJS.algo.SHA512.create();h.update(c),h.update(d),h.update(e);var i=h.finalize();b.headers["auth-username"]=g,b.headers["auth-ts"]=e,b.headers["auth-salt"]=d,b.headers["auth-token"]=i.toString(CryptoJS.enc.Hex)}return b}}}).config(["$httpProvider",function(a){a.interceptors.push("Authinterceptor")}]),angular.module("openhimConsoleApp").factory("login",["Api","Authinterceptor",function(a,b){var c={};return{login:function(d,e,f){a.Authenticate.get({email:d},function(g){if(g.salt){c.clientTimeStamp=(new Date).getTime(),c.serverTimeStamp=new Date(g.ts).getTime(),c.timeDiff=c.serverTimeStamp-c.clientTimeStamp;var h=CryptoJS.algo.SHA512.create();h.update(g.salt),h.update(e);var i=h.finalize();c.email=d,c.passwordHash=i.toString(CryptoJS.enc.Hex),b.setLoggedInUser(c),a.Users.get({email:d},function(a){c=a,f("Authentication Success")},function(){f("Authentication Failed")})}else f("Authentication Failed")},function(a){f(a.status?"Authentication Failed":"Internal Server Error")})},logout:function(){c=null},getLoggedInUser:function(){return c},isLoggedIn:function(){return null!==c?"undefined"!=typeof c.passwordHash:!1}}}]),angular.module("openhimConsoleApp").factory("Alerting",["$rootScope",function(a){return a.alerts={},{AlertAddMsg:function(b,c,d){a.alerts[b]||(a.alerts[b]=[]);var e={type:c,msg:d};a.alerts[b].push(e)},AlertAddServerMsg:function(b){var c;switch(b){case 403:c="The request has been forbidden by the server. Please contact the server administrator";break;case 404:c="The request resource could not be found";break;default:c="A server-side error has occurred. Please contact the server administrator"}a.alerts.server||(a.alerts.server=[]);var d={type:"danger",msg:c};a.alerts.server.push(d)},AlertReset:function(b){b?a.alerts&&(a.alerts[b]=void 0):a.alerts={}},AlertValidationMsgs:function(){a.validationRequiredMsg="This field is required!",a.validationPasswordConfirmMsg="Please confirm you password!",a.validationFormErrorsMsg="There appears to be some errors in your form. Please correct and try again."}}}]).run(["$rootScope",function(a){a.$on("$routeChangeStart",function(){a.alerts={}})}]),angular.module("openhimConsoleApp").factory("AuditLookups",function(){return{eventActionMap:function(){var a={};return a.C="Create (C)",a.R="Read (R)",a.U="Update (U)",a.D="Delete (D)",a.E="Execute (E)",a},eventOutcomeMap:function(){var a={};return a[0]="Success (0)",a[4]="Minor Failure (4)",a[8]="Serious Failure (8)",a[12]="Major Failure (12)",a}}}),angular.module("openhimConsoleApp").factory("MediatorDisplay",["config",function(a){var b=function(b){var c=function(){return Math.abs(Date.now()-moment(b._lastHeartbeat))/1e3};b._lastHeartbeat?(c()<a.mediatorLastHeartbeatWarningSeconds?b.lastHeartbeatStatus="success":c()<a.mediatorLastHeartbeatDangerSeconds?(b.lastHeartbeatStatus="warning",b.lastHeartbeatDisplayExplain="No heartbeats received in over "+a.mediatorLastHeartbeatWarningSeconds+" s"):(b.lastHeartbeatStatus="danger",b.lastHeartbeatDisplayExplain="No heartbeats received in over "+a.mediatorLastHeartbeatDangerSeconds+" s"),b.lastHeartbeatDisplay=moment(b._lastHeartbeat).fromNow()):(b.lastHeartbeatStatus="never",b.lastHeartbeatDisplayExplain="No heartbeats have ever been received from this mediator. Perhaps it doesn't support heartbeats."),b._uptime&&(b.uptimeDisplay=moment().subtract(b._uptime,"seconds").fromNow(!0),b.uptimeSince=moment(b._lastHeartbeat).subtract(b._uptime,"seconds").toDate())};return{formatMediator:b,formatMediators:function(a){angular.forEach(a,b)}}}]),angular.module("openhimConsoleApp").factory("Metrics",function(){return{refreshDatesForSelectedPeriod:function(a){"1h"===a.period?(a.from=moment().subtract(1,"hour").toDate(),a.until=moment().toDate(),a.type="minute"):"1d"===a.period?(a.from=moment().subtract(1,"day").toDate(),a.until=moment().toDate(),a.type="hour"):"1w"===a.period?(a.from=moment().subtract(1,"week").toDate(),a.until=moment().toDate(),a.type="day"):"1m"===a.period?(a.from=moment().subtract(1,"month").toDate(),a.until=moment().toDate(),a.type="day"):"1y"===a.period?(a.from=moment().subtract(1,"year").toDate(),a.until=moment().toDate(),a.type="month"):"5y"===a.period&&(a.from=moment().subtract(5,"years").toDate(),a.until=moment().toDate(),a.type="month")},buildLineChartData:function(a,b,c,d){for(var e=[],f=moment(a.from),g=moment(a.until),h=a.type+"s",i=0,j=0,k=0,l=Math.abs(f.diff(g,h)),m=0;l>=m;m++){for(var n=f.clone().add(m,h),o=0,p=0;p<b.length;p++){var q=moment(b[p].timestamp);n.isSame(q,a.type)&&(o=b[p][c],d&&(o=d(o)),j+=b[p].total,i+=b[p].avgResp)}e.push({timestamp:n.format("YYYY-MM-DD HH:mm"),value:o})}return k=(i/b.length).toFixed(2),{data:e,xkey:"timestamp",ykeys:["value"],labels:["Transactions"],loadTotal:j,avgResponseTime:k}}}});